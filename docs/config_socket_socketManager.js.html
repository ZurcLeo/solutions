<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: config/socket/socketManager.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: config/socket/socketManager.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * socketManager.js
 * Gerencia a instância do Socket.IO, mantém mapeamento de usuários para sockets,
 * e fornece funções utilitárias para comunicação via socket.
 */

const { logger } = require('../../logger');
const events = require('./socketEvents');

class SocketManager {
  constructor() {
    this.io = null;
    this.userSockets = new Map(); // userId -> Set of socket.ids
    this.socketUsers = new Map(); // socket.id -> userId
    this.userRooms = new Map();   // userId -> Set of rooms
    this.isInitialized = false;
  }

  /**
   * Inicializa o SocketManager com uma instância do Socket.IO
   * @param {SocketIO.Server} io - Instância do Socket.IO
   */
  initialize(io) {
    if (this.isInitialized) {
      logger.warn('SocketManager já foi inicializado', {
        service: 'socket',
        function: 'initialize'
      });
      return;
    }

    this.io = io;
    this.isInitialized = true;

    logger.info('SocketManager inicializado', {
      service: 'socket',
      function: 'initialize'
    });
  }

  /**
   * Registra um socket para um usuário
   * @param {string} socketId - ID do socket
   * @param {string} userId - ID do usuário
   */
  registerSocket(socketId, userId) {
    if (!socketId || !userId) {
      logger.warn('Tentativa de registrar socket sem socketId ou userId', {
        service: 'socket',
        function: 'registerSocket',
        socketId,
        userId
      });
      return;
    }

    // Registra o socket para o usuário
    if (!this.userSockets.has(userId)) {
      this.userSockets.set(userId, new Set());
    }
    this.userSockets.get(userId).add(socketId);

    // Mapeia o socket para o usuário
    this.socketUsers.set(socketId, userId);

    logger.info('Socket registrado para usuário', {
      service: 'socket',
      function: 'registerSocket',
      socketId,
      userId,
      activeSockets: this.userSockets.get(userId).size
    });
  }

  /**
   * Remove o registro de um socket
   * @param {string} socketId - ID do socket a ser removido
   */
  removeSocket(socketId) {
    if (!socketId) return;

    const userId = this.socketUsers.get(socketId);
    if (userId) {
      // Remove o socket da lista de sockets do usuário
      const userSocketSet = this.userSockets.get(userId);
      if (userSocketSet) {
        userSocketSet.delete(socketId);
        
        // Se não houver mais sockets para este usuário, remover entrada
        if (userSocketSet.size === 0) {
          this.userSockets.delete(userId);
          
          // Notificar outros usuários que este usuário está offline
          this.broadcastUserStatus(userId, false);
        }
      }
      
      // Remove o mapeamento socket -> usuário
      this.socketUsers.delete(socketId);

      logger.info('Socket removido do registro', {
        service: 'socket',
        function: 'removeSocket',
        socketId,
        userId,
        remainingSockets: userSocketSet ? userSocketSet.size : 0
      });
    }
  }

  /**
   * Retorna todos os sockets de um usuário
   * @param {string} userId - ID do usuário
   * @returns {Array} Array de objetos socket
   */
  getUserSockets(userId) {
    if (!userId || !this.userSockets.has(userId)) {
      return [];
    }

    const socketIds = Array.from(this.userSockets.get(userId));
    return socketIds.map(id => this.io.sockets.sockets.get(id)).filter(Boolean);
  }

  /**
   * Verifica se um usuário está online (tem pelo menos um socket conectado)
   * @param {string} userId - ID do usuário
   * @returns {boolean} True se o usuário estiver online
   */
  isUserOnline(userId) {
    return this.userSockets.has(userId) &amp;&amp; this.userSockets.get(userId).size > 0;
  }

  /**
   * Registra que um usuário entrou em uma sala
   * @param {string} userId - ID do usuário
   * @param {string} room - Nome da sala
   */
  addUserToRoom(userId, room) {
    if (!userId || !room) return;
    
    if (!this.userRooms.has(userId)) {
      this.userRooms.set(userId, new Set());
    }
    this.userRooms.get(userId).add(room);

    logger.info('Usuário adicionado à sala', {
      service: 'socket',
      function: 'addUserToRoom',
      userId,
      room
    });
  }

  /**
   * Remove um usuário de uma sala
   * @param {string} userId - ID do usuário
   * @param {string} room - Nome da sala
   */
  removeUserFromRoom(userId, room) {
    if (!userId || !room) return;
    
    const userRooms = this.userRooms.get(userId);
    if (userRooms) {
      userRooms.delete(room);
      
      if (userRooms.size === 0) {
        this.userRooms.delete(userId);
      }

      logger.info('Usuário removido da sala', {
        service: 'socket',
        function: 'removeUserFromRoom',
        userId,
        room
      });
    }
  }

  /**
   * Lista todas as salas de um usuário
   * @param {string} userId - ID do usuário
   * @returns {Array} Array com os nomes das salas
   */
  getUserRooms(userId) {
    if (!userId || !this.userRooms.has(userId)) {
      return [];
    }
    return Array.from(this.userRooms.get(userId));
  }

  /**
   * Envia um evento para um usuário específico em todos os seus dispositivos
   * @param {string} userId - ID do usuário
   * @param {string} event - Nome do evento
   * @param {*} data - Dados a serem enviados
   * @returns {boolean} Sucesso do envio
   */
  emitToUser(userId, event, data) {
    if (!this.isInitialized || !userId || !event) {
      return false;
    }

    const sockets = this.getUserSockets(userId);
    if (sockets.length === 0) {
      logger.warn('Tentativa de emitir evento para usuário sem sockets conectados', {
        service: 'socket',
        function: 'emitToUser',
        userId,
        event
      });
      return false;
    }

    sockets.forEach(socket => {
      if (socket) {
        socket.emit(event, data);
      }
    });

    logger.info('Evento emitido para usuário', {
      service: 'socket',
      function: 'emitToUser',
      userId,
      event,
      socketCount: sockets.length
    });

    return true;
  }

  /**
   * Emite um evento para uma sala específica
   * @param {string} room - Nome da sala
   * @param {string} event - Nome do evento
   * @param {*} data - Dados a serem enviados
   */
  emitToRoom(room, event, data) {
    if (!this.isInitialized || !room || !event) {
      return false;
    }

    this.io.to(room).emit(event, data);

    logger.info('Evento emitido para sala', {
      service: 'socket',
      function: 'emitToRoom',
      room,
      event
    });

    return true;
  }

  /**
   * Emite um evento para todos os usuários conectados exceto o emissor
   * @param {string} senderUserId - ID do usuário emissor
   * @param {string} event - Nome do evento
   * @param {*} data - Dados a serem enviados
   */
  broadcastToAll(senderUserId, event, data) {
    if (!this.isInitialized || !event) {
      return false;
    }

    // Se houver um emissor, excluir seus sockets
    const excludeSockets = senderUserId ? this.getUserSockets(senderUserId) : [];
    const excludeIds = excludeSockets.map(socket => socket.id);

    for (const [userId, socketIds] of this.userSockets.entries()) {
      // Ignorar o emissor
      if (userId === senderUserId) continue;

      for (const socketId of socketIds) {
        // Verificar se este socket não está na lista de exclusão
        if (!excludeIds.includes(socketId)) {
          const socket = this.io.sockets.sockets.get(socketId);
          if (socket) {
            socket.emit(event, data);
          }
        }
      }
    }

    logger.info('Evento broadcast emitido', {
      service: 'socket',
      function: 'broadcastToAll',
      event,
      excludedUser: senderUserId
    });

    return true;
  }

  /**
   * Notifica todos os usuários sobre a mudança de status de um usuário
   * @param {string} userId - ID do usuário que mudou de status
   * @param {boolean} isOnline - Status online (true) ou offline (false)
   */
  broadcastUserStatus(userId, isOnline) {
    if (!userId) return;

    const statusEvent = isOnline 
      ? events.PRESENCE_EVENTS.USER_ONLINE 
      : events.PRESENCE_EVENTS.USER_OFFLINE;

    this.broadcastToAll(userId, statusEvent, { userId, timestamp: Date.now() });
  }

  /**
   * Retorna lista de usuários online
   * @returns {Array} Array com IDs dos usuários online
   */
  getOnlineUsers() {
    return Array.from(this.userSockets.keys());
  }

  /**
   * Desconecta todos os sockets de um usuário
   * @param {string} userId - ID do usuário
   */
  disconnectUser(userId) {
    if (!userId) return;

    const sockets = this.getUserSockets(userId);
    sockets.forEach(socket => {
      if (socket) {
        socket.disconnect(true);
      }
    });

    logger.info('Usuário desconectado forçadamente', {
      service: 'socket',
      function: 'disconnectUser',
      userId,
      socketCount: sockets.length
    });
  }

  /**
   * Limpa todas as informações quando o servidor é encerrado
   */
  shutdown() {
    this.userSockets.clear();
    this.socketUsers.clear();
    this.userRooms.clear();
    this.isInitialized = false;

    logger.info('SocketManager desligado', {
      service: 'socket',
      function: 'shutdown'
    });
  }
}

// Exporta uma instância singleton
module.exports = new SocketManager();</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-controllers_authController.html">controllers/authController</a></li><li><a href="module-controllers_blacklistController.html">controllers/blacklistController</a></li><li><a href="module-controllers_connectionsController.html">controllers/connectionsController</a></li><li><a href="module-controllers_emailController.html">controllers/emailController</a></li><li><a href="module-controllers_groupsCaixinhaController.html">controllers/groupsCaixinhaController</a></li><li><a href="module-controllers_interestsController.html">controllers/interestsController</a></li><li><a href="module-controllers_inviteController.html">controllers/inviteController</a></li><li><a href="module-controllers_notificationsController.html">controllers/notificationsController</a></li><li><a href="module-controllers_openaiController.html">controllers/openaiController</a></li><li><a href="module-controllers_permissionController.html">controllers/permissionController</a></li><li><a href="module-controllers_postController.html">controllers/postController</a></li><li><a href="module-controllers_recaptchaController.html">controllers/recaptchaController</a></li><li><a href="module-controllers_rifaController.html">controllers/rifaController</a></li><li><a href="module-controllers_roleController.html">controllers/roleController</a></li><li><a href="module-controllers_userController.html">controllers/userController</a></li><li><a href="module-controllers_videoSdkController.html">controllers/videoSdkController</a></li><li><a href="module-services_CaixinhaInviteService.html">services/CaixinhaInviteService</a></li><li><a href="module-services_SupportService.html">services/SupportService</a></li><li><a href="module-services_authService.html">services/authService</a></li><li><a href="module-services_blacklistService.html">services/blacklistService</a></li><li><a href="module-services_caixinhaService.html">services/caixinhaService</a></li><li><a href="module-services_connectionService.html">services/connectionService</a></li><li><a href="module-services_contribuicaoService.html">services/contribuicaoService</a></li><li><a href="module-services_disputeService.html">services/disputeService</a></li><li><a href="module-services_emailService.html">services/emailService</a></li><li><a href="module-services_encryptionService.html">services/encryptionService</a></li><li><a href="module-services_inviteService.html">services/inviteService</a></li><li><a href="module-services_ja3Service.html">services/ja3Service</a></li></ul><h3>Namespaces</h3><ul><li><a href="module-services_emailService-emailService.html">emailService</a></li></ul><h3>Classes</h3><ul><li><a href="AppError.html">AppError</a></li><li><a href="AuthenticationError.html">AuthenticationError</a></li><li><a href="ConflictError.html">ConflictError</a></li><li><a href="ForbiddenError.html">ForbiddenError</a></li><li><a href="HttpError.html">HttpError</a></li><li><a href="Invite.html">Invite</a></li><li><a href="Message.html">Message</a></li><li><a href="NotFoundError.html">NotFoundError</a></li><li><a href="PermissionService.html">PermissionService</a></li><li><a href="RateLimitError.html">RateLimitError</a></li><li><a href="RoleService.html">RoleService</a></li><li><a href="ServiceError.html">ServiceError</a></li><li><a href="UserRoleService.html">UserRoleService</a></li><li><a href="ValidationError.html">ValidationError</a></li></ul><h3>Global</h3><ul><li><a href="global.html#_calculateSimilarity">_calculateSimilarity</a></li><li><a href="global.html#_findPendingAccountsForPayment">_findPendingAccountsForPayment</a></li><li><a href="global.html#_levenshteinDistance">_levenshteinDistance</a></li><li><a href="global.html#_processPaymentNotification">_processPaymentNotification</a></li><li><a href="global.html#_validatePayerData">_validatePayerData</a></li><li><a href="global.html#_verifyWebhookSignature">_verifyWebhookSignature</a></li><li><a href="global.html#acceptInvite">acceptInvite</a></li><li><a href="global.html#activateBankAccount">activateBankAccount</a></li><li><a href="global.html#addContribuicao">addContribuicao</a></li><li><a href="global.html#approveLoan">approveLoan</a></li><li><a href="global.html#assignRoleToUser">assignRoleToUser</a></li><li><a href="global.html#asyncHandler">asyncHandler</a></li><li><a href="global.html#broadcastUserStatus">broadcastUserStatus</a></li><li><a href="global.html#cancelDispute">cancelDispute</a></li><li><a href="global.html#cancelInvite">cancelInvite</a></li><li><a href="global.html#cancelarRifa">cancelarRifa</a></li><li><a href="global.html#checkAuthService">checkAuthService</a></li><li><a href="global.html#checkBankValidation">checkBankValidation</a></li><li><a href="global.html#checkCaixinhaService">checkCaixinhaService</a></li><li><a href="global.html#checkConnectionsService">checkConnectionsService</a></li><li><a href="global.html#checkDatabaseConnection">checkDatabaseConnection</a></li><li><a href="global.html#checkDependencies">checkDependencies</a></li><li><a href="global.html#checkDisputeRequirement">checkDisputeRequirement</a></li><li><a href="global.html#checkExpiredInvites">checkExpiredInvites</a></li><li><a href="global.html#checkFirebaseConnection">checkFirebaseConnection</a></li><li><a href="global.html#checkFullSystem">checkFullSystem</a></li><li><a href="global.html#checkInterestsService">checkInterestsService</a></li><li><a href="global.html#checkNotificationsService">checkNotificationsService</a></li><li><a href="global.html#checkPermission">checkPermission</a></li><li><a href="global.html#checkPublicServices">checkPublicServices</a></li><li><a href="global.html#checkRole">checkRole</a></li><li><a href="global.html#checkServerResources">checkServerResources</a></li><li><a href="global.html#checkServices">checkServices</a></li><li><a href="global.html#checkSpecificService">checkSpecificService</a></li><li><a href="global.html#checkUserService">checkUserService</a></li><li><a href="global.html#confirmBankValidation">confirmBankValidation</a></li><li><a href="global.html#createBankAccount">createBankAccount</a></li><li><a href="global.html#createCaixinha">createCaixinha</a></li><li><a href="global.html#createDispute">createDispute</a></li><li><a href="global.html#createHealthResponse">createHealthResponse</a></li><li><a href="global.html#createRifa">createRifa</a></li><li><a href="global.html#createRuleChangeDispute">createRuleChangeDispute</a></li><li><a href="global.html#deleteBankAccount">deleteBankAccount</a></li><li><a href="global.html#deleteCaixinha">deleteCaixinha</a></li><li><a href="global.html#dependenciesHealthCheck">dependenciesHealthCheck</a></li><li><a href="global.html#detectDeviceType">detectDeviceType</a></li><li><a href="global.html#determineOverallStatus">determineOverallStatus</a></li><li><a href="global.html#evaluateThreshold">evaluateThreshold</a></li><li><a href="global.html#extractToken">extractToken</a></li><li><a href="global.html#formatErrorForHealthResponse">formatErrorForHealthResponse</a></li><li><a href="global.html#fullSystemHealthCheck">fullSystemHealthCheck</a></li><li><a href="global.html#generateValidationCode">generateValidationCode</a></li><li><a href="global.html#generateValidationPix">generateValidationPix</a></li><li><a href="global.html#gerarComprovante">gerarComprovante</a></li><li><a href="global.html#gerarComprovanteSorteio">gerarComprovanteSorteio</a></li><li><a href="global.html#gerarHashVerificacao">gerarHashVerificacao</a></li><li><a href="global.html#gerarRelatorio">gerarRelatorio</a></li><li><a href="global.html#gerenciarEmprestimos">gerenciarEmprestimos</a></li><li><a href="global.html#gerenciarMembros">gerenciarMembros</a></li><li><a href="global.html#getAccountHistory">getAccountHistory</a></li><li><a href="global.html#getAllBankAccounts">getAllBankAccounts</a></li><li><a href="global.html#getAllRifasByCaixinha">getAllRifasByCaixinha</a></li><li><a href="global.html#getCaixinhaById">getCaixinhaById</a></li><li><a href="global.html#getCaixinhaInvites">getCaixinhaInvites</a></li><li><a href="global.html#getCaixinhas">getCaixinhas</a></li><li><a href="global.html#getDisputeById">getDisputeById</a></li><li><a href="global.html#getDisputeVoteInfo">getDisputeVoteInfo</a></li><li><a href="global.html#getDisputes">getDisputes</a></li><li><a href="global.html#getInvitationsByType">getInvitationsByType</a></li><li><a href="global.html#getInviteDetails">getInviteDetails</a></li><li><a href="global.html#getLoanById">getLoanById</a></li><li><a href="global.html#getLoanStats">getLoanStats</a></li><li><a href="global.html#getLoans">getLoans</a></li><li><a href="global.html#getMembers">getMembers</a></li><li><a href="global.html#getReceivedInvites">getReceivedInvites</a></li><li><a href="global.html#getRifaById">getRifaById</a></li><li><a href="global.html#getSentInvites">getSentInvites</a></li><li><a href="global.html#getUserRoles">getUserRoles</a></li><li><a href="global.html#getUserStatus">getUserStatus</a></li><li><a href="global.html#healthCheck">healthCheck</a></li><li><a href="global.html#initBankValidation">initBankValidation</a></li><li><a href="global.html#initializeFirstAdmin">initializeFirstAdmin</a></li><li><a href="global.html#initializeLocalStorage">initializeLocalStorage</a></li><li><a href="global.html#injectRoleInfo">injectRoleInfo</a></li><li><a href="global.html#inviteByEmail">inviteByEmail</a></li><li><a href="global.html#inviteExistingMember">inviteExistingMember</a></li><li><a href="global.html#isAdmin">isAdmin</a></li><li><a href="global.html#isUserOnline">isUserOnline</a></li><li><a href="global.html#listCollections">listCollections</a></li><li><a href="global.html#logServiceStatus">logServiceStatus</a></li><li><a href="global.html#makePayment">makePayment</a></li><li><a href="global.html#mercadoPagoWebhook">mercadoPagoWebhook</a></li><li><a href="global.html#migrateAdminUsers">migrateAdminUsers</a></li><li><a href="global.html#migrateInvitesToNewStructure">migrateInvitesToNewStructure</a></li><li><a href="global.html#obterNumeroAleatorioNIST">obterNumeroAleatorioNIST</a></li><li><a href="global.html#obterNumeroAleatorioRandomOrg">obterNumeroAleatorioRandomOrg</a></li><li><a href="global.html#obterResultadoLoteria">obterResultadoLoteria</a></li><li><a href="global.html#optionalAuth">optionalAuth</a></li><li><a href="global.html#parseCookies">parseCookies</a></li><li><a href="global.html#publicHealthCheck">publicHealthCheck</a></li><li><a href="global.html#realizarSorteio">realizarSorteio</a></li><li><a href="global.html#registerMessageHandlers">registerMessageHandlers</a></li><li><a href="global.html#registerNotificationHandlers">registerNotificationHandlers</a></li><li><a href="global.html#registerPresenceHandlers">registerPresenceHandlers</a></li><li><a href="global.html#rejectInvite">rejectInvite</a></li><li><a href="global.html#rejectLoan">rejectLoan</a></li><li><a href="global.html#rejectUserRole">rejectUserRole</a></li><li><a href="global.html#removeRoleFromUser">removeRoleFromUser</a></li><li><a href="global.html#requestLoan">requestLoan</a></li><li><a href="global.html#resendInvite">resendInvite</a></li><li><a href="global.html#resendInviteEmail">resendInviteEmail</a></li><li><a href="global.html#sendAlertsIfNeeded">sendAlertsIfNeeded</a></li><li><a href="global.html#sendRealTimeNotification">sendRealTimeNotification</a></li><li><a href="global.html#serviceCheckers">serviceCheckers</a></li><li><a href="global.html#serviceHealthCheck">serviceHealthCheck</a></li><li><a href="global.html#setupActivityMonitor">setupActivityMonitor</a></li><li><a href="global.html#setupGracefulShutdown">setupGracefulShutdown</a></li><li><a href="global.html#setupHealthMonitoring">setupHealthMonitoring</a></li><li><a href="global.html#setupSystemMonitoring">setupSystemMonitoring</a></li><li><a href="global.html#socketAuthMiddleware">socketAuthMiddleware</a></li><li><a href="global.html#socketLoggingMiddleware">socketLoggingMiddleware</a></li><li><a href="global.html#updateBankAccount">updateBankAccount</a></li><li><a href="global.html#updateCaixinha">updateCaixinha</a></li><li><a href="global.html#updateRifa">updateRifa</a></li><li><a href="global.html#updateUserStatus">updateUserStatus</a></li><li><a href="global.html#validateAccount">validateAccount</a></li><li><a href="global.html#validateUserRole">validateUserRole</a></li><li><a href="global.html#venderBilhete">venderBilhete</a></li><li><a href="global.html#verificarAutenticidadeSorteio">verificarAutenticidadeSorteio</a></li><li><a href="global.html#verificarConfiguracoes">verificarConfiguracoes</a></li><li><a href="global.html#verificarIntegridade">verificarIntegridade</a></li><li><a href="global.html#voteOnDispute">voteOnDispute</a></li><li><a href="global.html#webhookLogger">webhookLogger</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Tue Jun 24 2025 14:11:53 GMT-0300 (Brasilia Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
