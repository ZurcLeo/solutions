<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: config/socket/socketConfig.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: config/socket/socketConfig.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// config/socketConfig.js
const socketIo = require('socket.io');
const { logger } = require('../../logger');
const socketManager = require('./socketManager');
const socketAuthMiddleware = require('./middleware/authMiddleware');
const socketLoggingMiddleware = require('./middleware/loggingMiddleware');
const registerMessageHandlers = require('./handlers/messageHandlers');
const { registerNotificationHandlers } = require('./handlers/notificationHandlers');
const { registerPresenceHandlers } = require('./handlers/presenceHandlers');
const { SYSTEM_EVENTS } = require('./socketEvents');

module.exports = (server) => {
  // Configuração do Socket.IO com opções de CORS e cookies
  const io = socketIo(server, {
    cors: {
      origin: process.env.NODE_ENV === 'production' 
        ? process.env.FRONTEND_URL 
        : 'https://localhost:3000',
      methods: ['GET', 'POST'],
      credentials: true,
      transports: ['websocket', 'polling']
    },
    cookie: {
      name: 'io',
      path: '/',
      httpOnly: true,
      secure: true,
      sameSite: process.env.NODE_ENV === 'production' ? 'strict' : 'none'
    },
    // Configurações adicionais para melhor desempenho e segurança
    pingTimeout: 60000, // 60 segundos de timeout para ping
    pingInterval: 25000, // 25 segundos entre pings
    upgradeTimeout: 10000, // 10 segundos de timeout para upgrade de conexão
    maxHttpBufferSize: 1e6, // 1MB tamanho máximo de pacote
    allowEIO3: true, // Permitir compatibilidade com Socket.IO v3
    serveClient: false // Não servir cliente, usar CDN no frontend
  });

  // Inicializar o SocketManager com a instância do io
  socketManager.initialize(io);

  // Aplicar middlewares globais
  io.use(socketLoggingMiddleware);
  io.use(socketAuthMiddleware);

  // Configuração dos eventos do Socket.io
  io.on('connection', (socket) => {
    const userId = socket.user?.id;
    
    if (!userId) {
      logger.warn('Conexão socket estabelecida sem autenticação', {
        service: 'websocket',
        function: 'connection',
        socketId: socket.id
      });
      
      // Emitir erro de autenticação e desconectar após pequeno delay
      socket.emit(SYSTEM_EVENTS.AUTHENTICATION_ERROR, {
        message: 'Authentication required',
        reconnect: true
      });
      
      setTimeout(() => {
        socket.disconnect(true);
      }, 3000);
      
      return;
    }

    logger.info('WebSocket Connection Established:', {
      service: 'websocket',
      function: 'connection',
      socketId: socket.id,
      userId,
      deviceType: socket.connectionInfo?.deviceType || 'unknown'
    });

    // Registrar handlers para cada grupo de funcionalidade
    registerMessageHandlers(socket, userId);
    registerNotificationHandlers(socket, userId);
    registerPresenceHandlers(socket, userId, socket.connectionInfo);

    // Handler de desconexão
    socket.on('disconnect', (reason) => {
      logger.info('WebSocket Disconnected:', {
        service: 'websocket',
        function: 'disconnect',
        socketId: socket.id,
        userId,
        reason
      });

      // Remover o socket do gerenciador
      socketManager.removeSocket(socket.id);
    });

    // Monitoramento de erros de socket
    socket.on('error', (error) => {
      logger.error('WebSocket Error:', {
        service: 'websocket',
        function: 'error',
        socketId: socket.id,
        userId,
        error: error.message
      });
    });

    // Evento de reconexão
    socket.on('reconnect_attempt', (attemptNumber) => {
      logger.info('WebSocket Reconnect Attempt:', {
        service: 'websocket',
        function: 'reconnect_attempt',
        socketId: socket.id,
        userId,
        attemptNumber
      });
    });

    // Adicionar monitoramento de saúde do sistema
    setupHealthMonitoring(socket, userId);
  });

  // Monitoramento periódico do sistema de socket
  setupSystemMonitoring(io);

  // Manipulação de encerramento gracioso
  setupGracefulShutdown(io);

  return io;
};

/**
 * Configura monitoramento de saúde para um cliente específico
 * @param {SocketIO.Socket} socket - Socket do cliente
 * @param {string} userId - ID do usuário
 */
function setupHealthMonitoring(socket, userId) {
  // Ping-pong personalizado para clientes
  const heartbeatInterval = setInterval(() => {
    // Verificar se o socket ainda está conectado
    if (!socket.connected) {
      clearInterval(heartbeatInterval);
      return;
    }

    // Enviar ping e esperar resposta
    const startTime = Date.now();
    socket.emit('ping', { timestamp: startTime }, () => {
      const latency = Date.now() - startTime;
      
      // Armazenar latência nas métricas do socket (se existirem)
      if (socket.metrics) {
        socket.metrics.latency = latency;
      }
      
      // Registrar apenas se latência for alta (para evitar excesso de logs)
      if (latency > 200) {
        logger.warn('Alta latência detectada', {
          service: 'websocket',
          function: 'heartbeat',
          socketId: socket.id,
          userId,
          latencyMs: latency
        });
      }
    });
  }, 30000); // A cada 30 segundos

  // Limpar intervalo na desconexão
  socket.on('disconnect', () => {
    clearInterval(heartbeatInterval);
  });
}

/**
 * Configura monitoramento do sistema de socket
 * @param {SocketIO.Server} io - Instância do Socket.IO
 */
function setupSystemMonitoring(io) {
  const monitoringInterval = setInterval(() => {
    try {
      // Coletar estatísticas do sistema
      const connectedSockets = io.sockets.sockets.size;
      const rooms = io.sockets.adapter.rooms;
      const roomCount = rooms ? rooms.size : 0;
      
      // Obter estatísticas do SocketManager
      const onlineUsers = socketManager.getOnlineUsers().length;
      
      // Registrar métricas
      logger.info('Estatísticas do sistema de socket', {
        service: 'websocket',
        function: 'system_monitoring',
        connectedSockets,
        roomCount,
        onlineUsers,
        memoryUsage: process.memoryUsage().heapUsed,
        timestamp: new Date().toISOString()
      });
    } catch (error) {
      logger.error('Erro ao coletar estatísticas do sistema de socket', {
        service: 'websocket',
        function: 'system_monitoring',
        error: error.message
      });
    }
  }, 5 * 60 * 1000); // A cada 5 minutos

  // Armazenar intervalo para limpeza no encerramento
  global.socketMonitoringInterval = monitoringInterval;
}

/**
 * Configura rotinas para encerramento gracioso
 * @param {SocketIO.Server} io - Instância do Socket.IO
 */
function setupGracefulShutdown(io) {
  // Manipuladores para sinais de encerramento
  const shutdownHandler = (signal) => {
    logger.info(`Recebido sinal ${signal}, encerrando conexões Socket.IO`, {
      service: 'websocket',
      function: 'shutdown'
    });

    // Limpar intervalos de monitoramento
    if (global.socketMonitoringInterval) {
      clearInterval(global.socketMonitoringInterval);
    }

    // Notificar todos os clientes sobre o encerramento
    io.emit(SYSTEM_EVENTS.MAINTENANCE_NOTIFICATION, {
      message: 'Server maintenance, please reconnect in a few minutes',
      timestamp: Date.now()
    });

    // Dar um tempo para mensagens de notificação chegarem aos clientes
    setTimeout(() => {
      // Fechar todas as conexões
      io.close(() => {
        logger.info('Todas as conexões Socket.IO encerradas com sucesso', {
          service: 'websocket',
          function: 'shutdown'
        });
        
        // Desligar o SocketManager
        socketManager.shutdown();
      });
    }, 1000);
  };

  // Registrar handlers para sinais do sistema operacional
  process.on('SIGTERM', () => shutdownHandler('SIGTERM'));
  process.on('SIGINT', () => shutdownHandler('SIGINT'));
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-controllers_authController.html">controllers/authController</a></li><li><a href="module-controllers_blacklistController.html">controllers/blacklistController</a></li><li><a href="module-controllers_connectionsController.html">controllers/connectionsController</a></li><li><a href="module-controllers_emailController.html">controllers/emailController</a></li><li><a href="module-controllers_groupsCaixinhaController.html">controllers/groupsCaixinhaController</a></li><li><a href="module-controllers_interestsController.html">controllers/interestsController</a></li><li><a href="module-controllers_inviteController.html">controllers/inviteController</a></li><li><a href="module-controllers_notificationsController.html">controllers/notificationsController</a></li><li><a href="module-controllers_openaiController.html">controllers/openaiController</a></li><li><a href="module-controllers_permissionController.html">controllers/permissionController</a></li><li><a href="module-controllers_postController.html">controllers/postController</a></li><li><a href="module-controllers_recaptchaController.html">controllers/recaptchaController</a></li><li><a href="module-controllers_rifaController.html">controllers/rifaController</a></li><li><a href="module-controllers_roleController.html">controllers/roleController</a></li><li><a href="module-controllers_userController.html">controllers/userController</a></li><li><a href="module-controllers_videoSdkController.html">controllers/videoSdkController</a></li><li><a href="module-services_CaixinhaInviteService.html">services/CaixinhaInviteService</a></li><li><a href="module-services_SupportService.html">services/SupportService</a></li><li><a href="module-services_authService.html">services/authService</a></li><li><a href="module-services_blacklistService.html">services/blacklistService</a></li><li><a href="module-services_caixinhaService.html">services/caixinhaService</a></li><li><a href="module-services_connectionService.html">services/connectionService</a></li><li><a href="module-services_contribuicaoService.html">services/contribuicaoService</a></li><li><a href="module-services_disputeService.html">services/disputeService</a></li><li><a href="module-services_emailService.html">services/emailService</a></li><li><a href="module-services_encryptionService.html">services/encryptionService</a></li><li><a href="module-services_inviteService.html">services/inviteService</a></li><li><a href="module-services_ja3Service.html">services/ja3Service</a></li></ul><h3>Namespaces</h3><ul><li><a href="module-services_emailService-emailService.html">emailService</a></li></ul><h3>Classes</h3><ul><li><a href="AppError.html">AppError</a></li><li><a href="AuthenticationError.html">AuthenticationError</a></li><li><a href="ConflictError.html">ConflictError</a></li><li><a href="ForbiddenError.html">ForbiddenError</a></li><li><a href="HttpError.html">HttpError</a></li><li><a href="Invite.html">Invite</a></li><li><a href="Message.html">Message</a></li><li><a href="NotFoundError.html">NotFoundError</a></li><li><a href="PermissionService.html">PermissionService</a></li><li><a href="RateLimitError.html">RateLimitError</a></li><li><a href="RoleService.html">RoleService</a></li><li><a href="ServiceError.html">ServiceError</a></li><li><a href="UserRoleService.html">UserRoleService</a></li><li><a href="ValidationError.html">ValidationError</a></li></ul><h3>Global</h3><ul><li><a href="global.html#_calculateSimilarity">_calculateSimilarity</a></li><li><a href="global.html#_findPendingAccountsForPayment">_findPendingAccountsForPayment</a></li><li><a href="global.html#_levenshteinDistance">_levenshteinDistance</a></li><li><a href="global.html#_processPaymentNotification">_processPaymentNotification</a></li><li><a href="global.html#_validatePayerData">_validatePayerData</a></li><li><a href="global.html#_verifyWebhookSignature">_verifyWebhookSignature</a></li><li><a href="global.html#acceptInvite">acceptInvite</a></li><li><a href="global.html#activateBankAccount">activateBankAccount</a></li><li><a href="global.html#addContribuicao">addContribuicao</a></li><li><a href="global.html#approveLoan">approveLoan</a></li><li><a href="global.html#assignRoleToUser">assignRoleToUser</a></li><li><a href="global.html#asyncHandler">asyncHandler</a></li><li><a href="global.html#broadcastUserStatus">broadcastUserStatus</a></li><li><a href="global.html#cancelDispute">cancelDispute</a></li><li><a href="global.html#cancelInvite">cancelInvite</a></li><li><a href="global.html#cancelarRifa">cancelarRifa</a></li><li><a href="global.html#checkAuthService">checkAuthService</a></li><li><a href="global.html#checkBankValidation">checkBankValidation</a></li><li><a href="global.html#checkCaixinhaService">checkCaixinhaService</a></li><li><a href="global.html#checkConnectionsService">checkConnectionsService</a></li><li><a href="global.html#checkDatabaseConnection">checkDatabaseConnection</a></li><li><a href="global.html#checkDependencies">checkDependencies</a></li><li><a href="global.html#checkDisputeRequirement">checkDisputeRequirement</a></li><li><a href="global.html#checkExpiredInvites">checkExpiredInvites</a></li><li><a href="global.html#checkFirebaseConnection">checkFirebaseConnection</a></li><li><a href="global.html#checkFullSystem">checkFullSystem</a></li><li><a href="global.html#checkInterestsService">checkInterestsService</a></li><li><a href="global.html#checkNotificationsService">checkNotificationsService</a></li><li><a href="global.html#checkPermission">checkPermission</a></li><li><a href="global.html#checkPublicServices">checkPublicServices</a></li><li><a href="global.html#checkRole">checkRole</a></li><li><a href="global.html#checkServerResources">checkServerResources</a></li><li><a href="global.html#checkServices">checkServices</a></li><li><a href="global.html#checkSpecificService">checkSpecificService</a></li><li><a href="global.html#checkUserService">checkUserService</a></li><li><a href="global.html#confirmBankValidation">confirmBankValidation</a></li><li><a href="global.html#createBankAccount">createBankAccount</a></li><li><a href="global.html#createCaixinha">createCaixinha</a></li><li><a href="global.html#createDispute">createDispute</a></li><li><a href="global.html#createHealthResponse">createHealthResponse</a></li><li><a href="global.html#createRifa">createRifa</a></li><li><a href="global.html#createRuleChangeDispute">createRuleChangeDispute</a></li><li><a href="global.html#deleteBankAccount">deleteBankAccount</a></li><li><a href="global.html#deleteCaixinha">deleteCaixinha</a></li><li><a href="global.html#dependenciesHealthCheck">dependenciesHealthCheck</a></li><li><a href="global.html#detectDeviceType">detectDeviceType</a></li><li><a href="global.html#determineOverallStatus">determineOverallStatus</a></li><li><a href="global.html#evaluateThreshold">evaluateThreshold</a></li><li><a href="global.html#extractToken">extractToken</a></li><li><a href="global.html#formatErrorForHealthResponse">formatErrorForHealthResponse</a></li><li><a href="global.html#fullSystemHealthCheck">fullSystemHealthCheck</a></li><li><a href="global.html#generateValidationCode">generateValidationCode</a></li><li><a href="global.html#generateValidationPix">generateValidationPix</a></li><li><a href="global.html#gerarComprovante">gerarComprovante</a></li><li><a href="global.html#gerarComprovanteSorteio">gerarComprovanteSorteio</a></li><li><a href="global.html#gerarHashVerificacao">gerarHashVerificacao</a></li><li><a href="global.html#gerarRelatorio">gerarRelatorio</a></li><li><a href="global.html#gerenciarEmprestimos">gerenciarEmprestimos</a></li><li><a href="global.html#gerenciarMembros">gerenciarMembros</a></li><li><a href="global.html#getAccountHistory">getAccountHistory</a></li><li><a href="global.html#getAllBankAccounts">getAllBankAccounts</a></li><li><a href="global.html#getAllRifasByCaixinha">getAllRifasByCaixinha</a></li><li><a href="global.html#getCaixinhaById">getCaixinhaById</a></li><li><a href="global.html#getCaixinhaInvites">getCaixinhaInvites</a></li><li><a href="global.html#getCaixinhas">getCaixinhas</a></li><li><a href="global.html#getDisputeById">getDisputeById</a></li><li><a href="global.html#getDisputeVoteInfo">getDisputeVoteInfo</a></li><li><a href="global.html#getDisputes">getDisputes</a></li><li><a href="global.html#getInvitationsByType">getInvitationsByType</a></li><li><a href="global.html#getInviteDetails">getInviteDetails</a></li><li><a href="global.html#getLoanById">getLoanById</a></li><li><a href="global.html#getLoanStats">getLoanStats</a></li><li><a href="global.html#getLoans">getLoans</a></li><li><a href="global.html#getMembers">getMembers</a></li><li><a href="global.html#getReceivedInvites">getReceivedInvites</a></li><li><a href="global.html#getRifaById">getRifaById</a></li><li><a href="global.html#getSentInvites">getSentInvites</a></li><li><a href="global.html#getUserRoles">getUserRoles</a></li><li><a href="global.html#getUserStatus">getUserStatus</a></li><li><a href="global.html#healthCheck">healthCheck</a></li><li><a href="global.html#initBankValidation">initBankValidation</a></li><li><a href="global.html#initializeFirstAdmin">initializeFirstAdmin</a></li><li><a href="global.html#initializeLocalStorage">initializeLocalStorage</a></li><li><a href="global.html#injectRoleInfo">injectRoleInfo</a></li><li><a href="global.html#inviteByEmail">inviteByEmail</a></li><li><a href="global.html#inviteExistingMember">inviteExistingMember</a></li><li><a href="global.html#isAdmin">isAdmin</a></li><li><a href="global.html#isUserOnline">isUserOnline</a></li><li><a href="global.html#listCollections">listCollections</a></li><li><a href="global.html#logServiceStatus">logServiceStatus</a></li><li><a href="global.html#makePayment">makePayment</a></li><li><a href="global.html#mercadoPagoWebhook">mercadoPagoWebhook</a></li><li><a href="global.html#migrateAdminUsers">migrateAdminUsers</a></li><li><a href="global.html#migrateInvitesToNewStructure">migrateInvitesToNewStructure</a></li><li><a href="global.html#obterNumeroAleatorioNIST">obterNumeroAleatorioNIST</a></li><li><a href="global.html#obterNumeroAleatorioRandomOrg">obterNumeroAleatorioRandomOrg</a></li><li><a href="global.html#obterResultadoLoteria">obterResultadoLoteria</a></li><li><a href="global.html#optionalAuth">optionalAuth</a></li><li><a href="global.html#parseCookies">parseCookies</a></li><li><a href="global.html#publicHealthCheck">publicHealthCheck</a></li><li><a href="global.html#realizarSorteio">realizarSorteio</a></li><li><a href="global.html#registerMessageHandlers">registerMessageHandlers</a></li><li><a href="global.html#registerNotificationHandlers">registerNotificationHandlers</a></li><li><a href="global.html#registerPresenceHandlers">registerPresenceHandlers</a></li><li><a href="global.html#rejectInvite">rejectInvite</a></li><li><a href="global.html#rejectLoan">rejectLoan</a></li><li><a href="global.html#rejectUserRole">rejectUserRole</a></li><li><a href="global.html#removeRoleFromUser">removeRoleFromUser</a></li><li><a href="global.html#requestLoan">requestLoan</a></li><li><a href="global.html#resendInvite">resendInvite</a></li><li><a href="global.html#resendInviteEmail">resendInviteEmail</a></li><li><a href="global.html#sendAlertsIfNeeded">sendAlertsIfNeeded</a></li><li><a href="global.html#sendRealTimeNotification">sendRealTimeNotification</a></li><li><a href="global.html#serviceCheckers">serviceCheckers</a></li><li><a href="global.html#serviceHealthCheck">serviceHealthCheck</a></li><li><a href="global.html#setupActivityMonitor">setupActivityMonitor</a></li><li><a href="global.html#setupGracefulShutdown">setupGracefulShutdown</a></li><li><a href="global.html#setupHealthMonitoring">setupHealthMonitoring</a></li><li><a href="global.html#setupSystemMonitoring">setupSystemMonitoring</a></li><li><a href="global.html#socketAuthMiddleware">socketAuthMiddleware</a></li><li><a href="global.html#socketLoggingMiddleware">socketLoggingMiddleware</a></li><li><a href="global.html#updateBankAccount">updateBankAccount</a></li><li><a href="global.html#updateCaixinha">updateCaixinha</a></li><li><a href="global.html#updateRifa">updateRifa</a></li><li><a href="global.html#updateUserStatus">updateUserStatus</a></li><li><a href="global.html#validateAccount">validateAccount</a></li><li><a href="global.html#validateUserRole">validateUserRole</a></li><li><a href="global.html#venderBilhete">venderBilhete</a></li><li><a href="global.html#verificarAutenticidadeSorteio">verificarAutenticidadeSorteio</a></li><li><a href="global.html#verificarConfiguracoes">verificarConfiguracoes</a></li><li><a href="global.html#verificarIntegridade">verificarIntegridade</a></li><li><a href="global.html#voteOnDispute">voteOnDispute</a></li><li><a href="global.html#webhookLogger">webhookLogger</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Tue Jun 24 2025 14:11:53 GMT-0300 (Brasilia Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
