<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: services/authService.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: services/authService.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview Serviço de autenticação - gerencia tokens JWT e validações
 * @module services/authService
 * @requires firebaseAdmin
 * @requires jsonwebtoken
 * @requires ../models/User
 * @requires ../models/Invite
 * @requires ../logger
 * @requires ./blacklistService
 * @requires ./inviteService
 * @requires uuid
 * @requires dotenv
 */

//eloscloudapp/services/authService.js
const { getAuth, getFirestore } = require('../firebaseAdmin');
const jwt = require('jsonwebtoken');
const User = require('../models/User');
const Invite = require('../models/Invite');
const { logger } = require('../logger')
const { addToBlacklist, isTokenBlacklisted } = require('./blacklistService');
const { validateInvite, invalidateInvite } = require('./inviteService');
const { v4: uuidv4 } = require('uuid');
require('dotenv').config();

const db = getFirestore();

/**
 * Gera tokens JWT de acesso e refresh
 * @function generateToken
 * @param {Object} payload - Dados do usuário para incluir no token
 * @param {string} payload.uid - ID do usuário
 * @param {string} payload.email - Email do usuário
 * @returns {Object} Objeto contendo accessToken e refreshToken
 * @description Cria tokens JWT com tempos de expiração diferentes (15min access, 7d refresh)
 */
const generateToken = (payload) => {
  try {
    logger.info('Payload para gerar token:', payload);
    const accessToken = jwt.sign(payload, process.env.JWT_SECRET, { expiresIn: '15m' });
    const refreshToken = jwt.sign(payload, process.env.JWT_REFRESH_SECRET, { expiresIn: '7d' });
    logger.info('Tokens gerados:', { accessToken, refreshToken });
    return { accessToken, refreshToken };
  } catch (error) {
    logger.error('Erro ao gerar token:', error);
    return {}; // ou lançar o erro
  }
};

/**
 * Gera token de refresh para o usuário
 * @function generateRefreshToken
 * @param {Object} user - Objeto do usuário
 * @param {string} user.uid - ID do usuário
 * @param {string} user.email - Email do usuário
 * @returns {string} Token de refresh JWT
 * @description Cria token de refresh com validade de 7 dias
 */
const generateRefreshToken = (user) => {
  return jwt.sign(
    { 
      uid: user.uid,
      email: user.email 
    },
    process.env.JWT_REFRESH_SECRET,
    { expiresIn: '7d' }
  );
};

const verifyAndGenerateNewToken = async (refreshToken) => {
  try {
    // Decodificar e verificar o refresh token
    const decoded = jwt.verify(refreshToken, process.env.JWT_REFRESH_SECRET);

    // Verificar se o refresh token foi revogado (blacklist)
    const isBlacklisted = await isTokenBlacklisted(refreshToken);
    if (isBlacklisted) {
      throw new Error('Refresh token revogado.');
    }

    // Em vez de buscar o usuário completo, usar os dados do token
    // para gerar novos tokens. Isso reduz uma consulta ao banco de dados.
    const userData = {
      uid: decoded.uid,
      // Outros dados necessários presentes no token
    };

    // Gerar novos tokens de acesso e refresh
    const accessToken = generateToken(userData);
    const newRefreshToken = generateRefreshToken(userData);

    return { 
      accessToken, 
      refreshToken: newRefreshToken,
      userData // Incluir dados básicos do usuário para reduzir consultas
    };
  } catch (error) {
    console.error('Erro ao verificar e renovar token:', error.message);
    throw new Error('Erro ao verificar e renovar token: ' + error.message);
  }
};

/**
 * Cria o perfil de um novo usuário e, se disponível, estabelece uma conexão com quem o convidou
 * @param {Object} userRecord - Dados do usuário do Firebase
 * @param {string} inviteId - ID do convite (opcional)
 */
const createUserProfile = async (userRecord, inviteId = null) => {
  const auth = getAuth();
  const userDocRef = db.doc(`usuario/${userRecord.uid}`);
  const docSnap = await userDocRef.get();

  if (docSnap.exists) {
    return; // Usuário já existe, não fazer nada
  }

  const batch = db.batch();
  const email = userRecord.email;
  const defaultName = email.substring(0, email.indexOf('@'));
  
  // Preparar dados básicos do usuário
  const userData = {
    email: userRecord.email,
    nome: userRecord.displayName || defaultName || 'ElosCloud.Cliente',
    perfilPublico: false,
    dataCriacao: auth.firestore.FieldValue.serverTimestamp(),
    uid: userRecord.uid,
    tipoDeConta: 'Cliente',
    interesses: {},
    ja3hash: userRecord.ja3hash,
    reacoes: [],
    isOwnerOrAdmin: false,
    descricao: '',
    saldoElosCoins: 0,
    fotoDoPerfil: process.env.DEFAULT_PROFILE_IMG,
    amigos: [],
    amigosAutorizados: [],
    conversas: {},
  };
  
  batch.set(userDocRef, userData);
  
  // Verificar se existe um convite e processar a conexão com o remetente
  if (inviteId) {
    try {
      // Buscar dados do convite
      const { invite } = await Invite.getById(inviteId);
      
      if (invite &amp;&amp; invite.status === 'used' &amp;&amp; invite.senderId) {
        // Criar referência de solicitação mútua entre o novo usuário e quem o convidou
        
        // 1. Solicitação ao novo usuário
        batch.set(db.doc(`conexoes/${userRecord.uid}/recebidas/${invite.senderId}`), {
          dataSolicitacao: auth.firestore.FieldValue.serverTimestamp(),
          nome: invite.senderName || 'Usuário que convidou',
          uid: invite.senderId,
          status: 'pendente',
          fotoDoPerfil: invite.senderPhotoURL || process.env.DEFAULT_PROFILE_IMG,
          descricao: 'Conecte-se com quem te convidou para a plataforma.',
          amigos: [],
          inviteId: inviteId  // Referência ao convite original
        });
        
        // 2. Solicitação ao remetente do convite
        batch.set(db.doc(`conexoes/${invite.senderId}/enviadas/${userRecord.uid}`), {
          dataSolicitacao: auth.firestore.FieldValue.serverTimestamp(),
          nome: userRecord.displayName || defaultName,
          uid: userRecord.uid,
          status: 'pendente',
          fotoDoPerfil: process.env.DEFAULT_PROFILE_IMG,
          descricao: 'Usuário que você convidou criou uma conta.',
          amigos: [],
          inviteId: inviteId  // Referência ao convite original
        });
        
        console.log(`Criadas solicitações de conexão entre ${userRecord.uid} e ${invite.senderId}`);
      }
    } catch (error) {
      console.error(`Erro ao processar conexão do convite ${inviteId}:`, error);
      // Continuar mesmo com erro na conexão
    }
  }
  
  // Sempre adicionar o suporte como contato
  batch.set(db.doc(`conexoes/${userRecord.uid}/recebidas/${process.env.SUPPORT_PROFILE_ID}`), {
    dataSolicitacao: auth.firestore.FieldValue.serverTimestamp(),
    nome: 'Suporte ElosCloud',
    uid: process.env.SUPPORT_PROFILE_ID,
    status: 'pendente',
    fotoDoPerfil: process.env.SUPPORT_PROFILE_IMG,
    descricao: 'Estamos aqui para ajudar. Conecte-se para receber suporte.',
    amigos: [],
  });
  
  try {
    await batch.commit();
    console.log(`Perfil criado com sucesso para o usuário: ${userRecord.email}`);
  } catch (error) {
    console.error(`Erro ao criar perfil para o usuário: ${userRecord.email}`, error);
    throw new Error(`Erro ao criar perfil para o usuário: ${error.message}`);
  }
};


const registerWithEmail = async (userData, email, password, inviteId) => {
  // const auth = getAuth();
  // const inviteRef = await validateInvite(inviteId);
  // const userRecord = await auth.createUser({ email, password });
  // await sendEmailVerification(userRecord.uid);
  const user = await User.create(userData);
  await invalidateInvite(inviteId, email);

  // const accessToken = generateToken({ uid: userData.uid });
  // const refreshToken = generateRefreshToken({ uid: userData.uid });
  return { message: 'Conta criada com sucesso', user };
};

const signInWithEmail = async (email, password) => {
  const auth = getAuth();
  const userRecord = await auth.getUserByEmail(email);
  const accessToken = await auth.createCustomToken(userRecord.uid);

  if (!userRecord.emailVerified) {
    throw new Error('Por favor, verifique seu e-mail.');
  }

  await User.create(userRecord);

  const refreshToken = generateRefreshToken({ uid: userRecord.uid });
  return { message: 'Login bem-sucedido', accessToken, refreshToken };
};

const logout = async (idToken) => {
  await addToBlacklist(idToken);
  return { message: 'Logout successful and token blacklisted' };
};

const signInWithProvider = async (firebaseToken) => {
  const auth = getAuth();
  const decodedToken = await auth.verifyIdToken(firebaseToken);
  const userRecord = await auth.getUser(decodedToken.uid);

  // if (!userRecord.emailVerified) {
  //   throw new Error('Please verify your email first');
  // }

  // await createUserProfile(userRecord);
  
  // const accessToken = generateToken({ uid: userRecord.uid });
  // const refreshToken = generateRefreshToken({ uid: userRecord.uid });

  return {
    // accessToken,
    // refreshToken,
    success: true,
    user: userRecord
  };
};

const resendVerificationEmail = async () => {
  const auth = getAuth();
  if (auth.currentUser) {
    await sendEmailVerification(auth.currentUser);
    return { message: 'E-mail de verificação reenviado.' };
  }
  throw new Error('Erro ao reenviar e-mail de verificação');
};

const getCurrentUser = async (userId) => {
  const userProfile = await User.getById(userId);

  const userData = {
    ...userProfile
  };
  return userData;
};

module.exports = {
  generateToken,
  generateRefreshToken,
  verifyAndGenerateNewToken,
  createUserProfile,
  registerWithEmail,
  signInWithEmail,
  logout,
  signInWithProvider,
  resendVerificationEmail,
  getCurrentUser
};</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-controllers_authController.html">controllers/authController</a></li><li><a href="module-controllers_blacklistController.html">controllers/blacklistController</a></li><li><a href="module-controllers_connectionsController.html">controllers/connectionsController</a></li><li><a href="module-controllers_emailController.html">controllers/emailController</a></li><li><a href="module-controllers_groupsCaixinhaController.html">controllers/groupsCaixinhaController</a></li><li><a href="module-controllers_interestsController.html">controllers/interestsController</a></li><li><a href="module-controllers_inviteController.html">controllers/inviteController</a></li><li><a href="module-controllers_notificationsController.html">controllers/notificationsController</a></li><li><a href="module-controllers_openaiController.html">controllers/openaiController</a></li><li><a href="module-controllers_permissionController.html">controllers/permissionController</a></li><li><a href="module-controllers_postController.html">controllers/postController</a></li><li><a href="module-controllers_recaptchaController.html">controllers/recaptchaController</a></li><li><a href="module-controllers_rifaController.html">controllers/rifaController</a></li><li><a href="module-controllers_roleController.html">controllers/roleController</a></li><li><a href="module-controllers_userController.html">controllers/userController</a></li><li><a href="module-controllers_videoSdkController.html">controllers/videoSdkController</a></li><li><a href="module-services_CaixinhaInviteService.html">services/CaixinhaInviteService</a></li><li><a href="module-services_SupportService.html">services/SupportService</a></li><li><a href="module-services_authService.html">services/authService</a></li><li><a href="module-services_blacklistService.html">services/blacklistService</a></li><li><a href="module-services_caixinhaService.html">services/caixinhaService</a></li><li><a href="module-services_connectionService.html">services/connectionService</a></li><li><a href="module-services_contribuicaoService.html">services/contribuicaoService</a></li><li><a href="module-services_disputeService.html">services/disputeService</a></li><li><a href="module-services_emailService.html">services/emailService</a></li><li><a href="module-services_encryptionService.html">services/encryptionService</a></li><li><a href="module-services_inviteService.html">services/inviteService</a></li><li><a href="module-services_ja3Service.html">services/ja3Service</a></li></ul><h3>Namespaces</h3><ul><li><a href="module-services_emailService-emailService.html">emailService</a></li></ul><h3>Classes</h3><ul><li><a href="AppError.html">AppError</a></li><li><a href="AuthenticationError.html">AuthenticationError</a></li><li><a href="ConflictError.html">ConflictError</a></li><li><a href="ForbiddenError.html">ForbiddenError</a></li><li><a href="HttpError.html">HttpError</a></li><li><a href="Invite.html">Invite</a></li><li><a href="Message.html">Message</a></li><li><a href="NotFoundError.html">NotFoundError</a></li><li><a href="PermissionService.html">PermissionService</a></li><li><a href="RateLimitError.html">RateLimitError</a></li><li><a href="RoleService.html">RoleService</a></li><li><a href="ServiceError.html">ServiceError</a></li><li><a href="UserRoleService.html">UserRoleService</a></li><li><a href="ValidationError.html">ValidationError</a></li></ul><h3>Global</h3><ul><li><a href="global.html#_calculateSimilarity">_calculateSimilarity</a></li><li><a href="global.html#_findPendingAccountsForPayment">_findPendingAccountsForPayment</a></li><li><a href="global.html#_levenshteinDistance">_levenshteinDistance</a></li><li><a href="global.html#_processPaymentNotification">_processPaymentNotification</a></li><li><a href="global.html#_validatePayerData">_validatePayerData</a></li><li><a href="global.html#_verifyWebhookSignature">_verifyWebhookSignature</a></li><li><a href="global.html#acceptInvite">acceptInvite</a></li><li><a href="global.html#activateBankAccount">activateBankAccount</a></li><li><a href="global.html#addContribuicao">addContribuicao</a></li><li><a href="global.html#approveLoan">approveLoan</a></li><li><a href="global.html#assignRoleToUser">assignRoleToUser</a></li><li><a href="global.html#asyncHandler">asyncHandler</a></li><li><a href="global.html#broadcastUserStatus">broadcastUserStatus</a></li><li><a href="global.html#cancelDispute">cancelDispute</a></li><li><a href="global.html#cancelInvite">cancelInvite</a></li><li><a href="global.html#cancelarRifa">cancelarRifa</a></li><li><a href="global.html#checkAuthService">checkAuthService</a></li><li><a href="global.html#checkBankValidation">checkBankValidation</a></li><li><a href="global.html#checkCaixinhaService">checkCaixinhaService</a></li><li><a href="global.html#checkConnectionsService">checkConnectionsService</a></li><li><a href="global.html#checkDatabaseConnection">checkDatabaseConnection</a></li><li><a href="global.html#checkDependencies">checkDependencies</a></li><li><a href="global.html#checkDisputeRequirement">checkDisputeRequirement</a></li><li><a href="global.html#checkExpiredInvites">checkExpiredInvites</a></li><li><a href="global.html#checkFirebaseConnection">checkFirebaseConnection</a></li><li><a href="global.html#checkFullSystem">checkFullSystem</a></li><li><a href="global.html#checkInterestsService">checkInterestsService</a></li><li><a href="global.html#checkNotificationsService">checkNotificationsService</a></li><li><a href="global.html#checkPermission">checkPermission</a></li><li><a href="global.html#checkPublicServices">checkPublicServices</a></li><li><a href="global.html#checkRole">checkRole</a></li><li><a href="global.html#checkServerResources">checkServerResources</a></li><li><a href="global.html#checkServices">checkServices</a></li><li><a href="global.html#checkSpecificService">checkSpecificService</a></li><li><a href="global.html#checkUserService">checkUserService</a></li><li><a href="global.html#confirmBankValidation">confirmBankValidation</a></li><li><a href="global.html#createBankAccount">createBankAccount</a></li><li><a href="global.html#createCaixinha">createCaixinha</a></li><li><a href="global.html#createDispute">createDispute</a></li><li><a href="global.html#createHealthResponse">createHealthResponse</a></li><li><a href="global.html#createRifa">createRifa</a></li><li><a href="global.html#createRuleChangeDispute">createRuleChangeDispute</a></li><li><a href="global.html#deleteBankAccount">deleteBankAccount</a></li><li><a href="global.html#deleteCaixinha">deleteCaixinha</a></li><li><a href="global.html#dependenciesHealthCheck">dependenciesHealthCheck</a></li><li><a href="global.html#detectDeviceType">detectDeviceType</a></li><li><a href="global.html#determineOverallStatus">determineOverallStatus</a></li><li><a href="global.html#evaluateThreshold">evaluateThreshold</a></li><li><a href="global.html#extractToken">extractToken</a></li><li><a href="global.html#formatErrorForHealthResponse">formatErrorForHealthResponse</a></li><li><a href="global.html#fullSystemHealthCheck">fullSystemHealthCheck</a></li><li><a href="global.html#generateValidationCode">generateValidationCode</a></li><li><a href="global.html#generateValidationPix">generateValidationPix</a></li><li><a href="global.html#gerarComprovante">gerarComprovante</a></li><li><a href="global.html#gerarComprovanteSorteio">gerarComprovanteSorteio</a></li><li><a href="global.html#gerarHashVerificacao">gerarHashVerificacao</a></li><li><a href="global.html#gerarRelatorio">gerarRelatorio</a></li><li><a href="global.html#gerenciarEmprestimos">gerenciarEmprestimos</a></li><li><a href="global.html#gerenciarMembros">gerenciarMembros</a></li><li><a href="global.html#getAccountHistory">getAccountHistory</a></li><li><a href="global.html#getAllBankAccounts">getAllBankAccounts</a></li><li><a href="global.html#getAllRifasByCaixinha">getAllRifasByCaixinha</a></li><li><a href="global.html#getCaixinhaById">getCaixinhaById</a></li><li><a href="global.html#getCaixinhaInvites">getCaixinhaInvites</a></li><li><a href="global.html#getCaixinhas">getCaixinhas</a></li><li><a href="global.html#getDisputeById">getDisputeById</a></li><li><a href="global.html#getDisputeVoteInfo">getDisputeVoteInfo</a></li><li><a href="global.html#getDisputes">getDisputes</a></li><li><a href="global.html#getInvitationsByType">getInvitationsByType</a></li><li><a href="global.html#getInviteDetails">getInviteDetails</a></li><li><a href="global.html#getLoanById">getLoanById</a></li><li><a href="global.html#getLoanStats">getLoanStats</a></li><li><a href="global.html#getLoans">getLoans</a></li><li><a href="global.html#getMembers">getMembers</a></li><li><a href="global.html#getReceivedInvites">getReceivedInvites</a></li><li><a href="global.html#getRifaById">getRifaById</a></li><li><a href="global.html#getSentInvites">getSentInvites</a></li><li><a href="global.html#getUserRoles">getUserRoles</a></li><li><a href="global.html#getUserStatus">getUserStatus</a></li><li><a href="global.html#healthCheck">healthCheck</a></li><li><a href="global.html#initBankValidation">initBankValidation</a></li><li><a href="global.html#initializeFirstAdmin">initializeFirstAdmin</a></li><li><a href="global.html#initializeLocalStorage">initializeLocalStorage</a></li><li><a href="global.html#injectRoleInfo">injectRoleInfo</a></li><li><a href="global.html#inviteByEmail">inviteByEmail</a></li><li><a href="global.html#inviteExistingMember">inviteExistingMember</a></li><li><a href="global.html#isAdmin">isAdmin</a></li><li><a href="global.html#isUserOnline">isUserOnline</a></li><li><a href="global.html#listCollections">listCollections</a></li><li><a href="global.html#logServiceStatus">logServiceStatus</a></li><li><a href="global.html#makePayment">makePayment</a></li><li><a href="global.html#mercadoPagoWebhook">mercadoPagoWebhook</a></li><li><a href="global.html#migrateAdminUsers">migrateAdminUsers</a></li><li><a href="global.html#migrateInvitesToNewStructure">migrateInvitesToNewStructure</a></li><li><a href="global.html#obterNumeroAleatorioNIST">obterNumeroAleatorioNIST</a></li><li><a href="global.html#obterNumeroAleatorioRandomOrg">obterNumeroAleatorioRandomOrg</a></li><li><a href="global.html#obterResultadoLoteria">obterResultadoLoteria</a></li><li><a href="global.html#optionalAuth">optionalAuth</a></li><li><a href="global.html#parseCookies">parseCookies</a></li><li><a href="global.html#publicHealthCheck">publicHealthCheck</a></li><li><a href="global.html#realizarSorteio">realizarSorteio</a></li><li><a href="global.html#registerMessageHandlers">registerMessageHandlers</a></li><li><a href="global.html#registerNotificationHandlers">registerNotificationHandlers</a></li><li><a href="global.html#registerPresenceHandlers">registerPresenceHandlers</a></li><li><a href="global.html#rejectInvite">rejectInvite</a></li><li><a href="global.html#rejectLoan">rejectLoan</a></li><li><a href="global.html#rejectUserRole">rejectUserRole</a></li><li><a href="global.html#removeRoleFromUser">removeRoleFromUser</a></li><li><a href="global.html#requestLoan">requestLoan</a></li><li><a href="global.html#resendInvite">resendInvite</a></li><li><a href="global.html#resendInviteEmail">resendInviteEmail</a></li><li><a href="global.html#sendAlertsIfNeeded">sendAlertsIfNeeded</a></li><li><a href="global.html#sendRealTimeNotification">sendRealTimeNotification</a></li><li><a href="global.html#serviceCheckers">serviceCheckers</a></li><li><a href="global.html#serviceHealthCheck">serviceHealthCheck</a></li><li><a href="global.html#setupActivityMonitor">setupActivityMonitor</a></li><li><a href="global.html#setupGracefulShutdown">setupGracefulShutdown</a></li><li><a href="global.html#setupHealthMonitoring">setupHealthMonitoring</a></li><li><a href="global.html#setupSystemMonitoring">setupSystemMonitoring</a></li><li><a href="global.html#socketAuthMiddleware">socketAuthMiddleware</a></li><li><a href="global.html#socketLoggingMiddleware">socketLoggingMiddleware</a></li><li><a href="global.html#updateBankAccount">updateBankAccount</a></li><li><a href="global.html#updateCaixinha">updateCaixinha</a></li><li><a href="global.html#updateRifa">updateRifa</a></li><li><a href="global.html#updateUserStatus">updateUserStatus</a></li><li><a href="global.html#validateAccount">validateAccount</a></li><li><a href="global.html#validateUserRole">validateUserRole</a></li><li><a href="global.html#venderBilhete">venderBilhete</a></li><li><a href="global.html#verificarAutenticidadeSorteio">verificarAutenticidadeSorteio</a></li><li><a href="global.html#verificarConfiguracoes">verificarConfiguracoes</a></li><li><a href="global.html#verificarIntegridade">verificarIntegridade</a></li><li><a href="global.html#voteOnDispute">voteOnDispute</a></li><li><a href="global.html#webhookLogger">webhookLogger</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Tue Jun 24 2025 14:11:53 GMT-0300 (Brasilia Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
