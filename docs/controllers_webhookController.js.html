<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: controllers/webhookController.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: controllers/webhookController.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const paymentService = require('../services/paymentService');
const BankAccount = require('../models/BankAccount');
const { logger } = require('../logger');
const crypto = require('crypto');

/**
 * Webhook do Mercado Pago para notificações de pagamento
 * Responde rapidamente com 200 e processa em background
 */
exports.mercadoPagoWebhook = async (req, res) => {
  const { type, action, data } = req.body;
  const signature = req.headers['x-signature'];
  const requestId = req.headers['x-request-id'];

  logger.info('Webhook do Mercado Pago recebido', {
    controller: 'WebhookController',
    method: 'mercadoPagoWebhook',
    type,
    action,
    dataId: data?.id,
    requestId,
    action: 'WEBHOOK_RECEIVED'
  });

  // Responder imediatamente com 200 para confirmar recebimento
  res.status(200).json({ status: 'received' });

  // Processar webhook em background (não aguarda resultado)
  setImmediate(async () => {
    try {
      // 1. Verificar assinatura do webhook (se configurada)
      if (process.env.MERCADOPAGO_WEBHOOK_SECRET &amp;&amp; signature) {
        const isValidSignature = exports._verifyWebhookSignature(req, signature);
        if (!isValidSignature) {
          logger.warn('Assinatura do webhook inválida', {
            controller: 'WebhookController',
            method: 'mercadoPagoWebhook',
            requestId,
            action: 'INVALID_SIGNATURE'
          });
          return;
        }
      }

      // 2. Processar apenas eventos de pagamento atualizados
      if (type === 'payment' &amp;&amp; action === 'payment.updated' &amp;&amp; data?.id) {
        await exports._processPaymentNotification(data.id, requestId);
      } else {
        logger.info('Webhook ignorado - não é payment.updated', {
          controller: 'WebhookController',
          method: 'mercadoPagoWebhook',
          type,
          action,
          requestId
        });
      }

    } catch (error) {
      logger.error('Erro no processamento do webhook em background', {
        controller: 'WebhookController',
        method: 'mercadoPagoWebhook',
        type,
        action,
        dataId: data?.id,
        requestId,
        error: error.message,
        stack: error.stack,
        action: 'WEBHOOK_BACKGROUND_ERROR'
      });
    }
  });
};

/**
 * Processa notificação de pagamento
 */
exports._processPaymentNotification = async (paymentId, requestId) => {
  try {
    logger.info('Processando notificação de pagamento', {
      controller: 'WebhookController',
      method: '_processPaymentNotification',
      paymentId,
      requestId,
      action: 'PROCESSING_PAYMENT_NOTIFICATION'
    });

    // 1. Buscar detalhes do pagamento no Mercado Pago
    const paymentData = await paymentService.checkPaymentStatus(paymentId);

    // 2. Verificar se é um micropagamento de validação (R$ 0,01)
    if (paymentData.transaction_amount !== 0.01) {
      logger.info('Pagamento não é um micropagamento de validação', {
        controller: 'WebhookController',
        method: '_processPaymentNotification',
        paymentId,
        amount: paymentData.transaction_amount,
        action: 'NOT_VALIDATION_PAYMENT'
      });
      return;
    }

    // 3. Verificar se o pagamento foi aprovado
    if (paymentData.status !== 'approved') {
      logger.info('Pagamento não aprovado', {
        controller: 'WebhookController',
        method: '_processPaymentNotification',
        paymentId,
        status: paymentData.status,
        action: 'PAYMENT_NOT_APPROVED'
      });
      return;
    }

    // 4. Buscar conta bancária pendente que pode corresponder a este pagamento
    const pendingAccounts = await exports._findPendingAccountsForPayment(paymentData);

    for (const account of pendingAccounts) {
      try {
        // 5. Validar se os dados do pagador correspondem à conta
        const isValidPayer = await exports._validatePayerData(paymentData, account);
        
        if (isValidPayer) {
          // 6. Atualizar conta para validada
          await BankAccount.update(account.adminId, account.id, {
            status: 'validada',
            validatedAt: new Date().toISOString(),
            validationPaymentId: paymentId,
            autoValidated: true
          });

          logger.info('Conta bancária validada automaticamente via webhook', {
            controller: 'WebhookController',
            method: '_processPaymentNotification',
            paymentId,
            accountId: account.id,
            adminId: account.adminId,
            action: 'AUTO_VALIDATION_SUCCESS'
          });

          // Parar no primeiro match válido
          break;
        }
      } catch (validationError) {
        logger.warn('Erro na validação automática da conta', {
          controller: 'WebhookController',
          method: '_processPaymentNotification',
          paymentId,
          accountId: account.id,
          error: validationError.message,
          action: 'AUTO_VALIDATION_ERROR'
        });
      }
    }

  } catch (error) {
    logger.error('Erro no processamento da notificação de pagamento', {
      controller: 'WebhookController',
      method: '_processPaymentNotification',
      paymentId,
      requestId,
      error: error.message,
      stack: error.stack,
      action: 'PAYMENT_NOTIFICATION_ERROR'
    });
    throw error;
  }
};

/**
 * Busca contas bancárias pendentes que podem corresponder ao pagamento
 */
exports._findPendingAccountsForPayment = async (paymentData) => {
  try {
    // Esta é uma busca simplificada - em produção, você pode implementar
    // uma estratégia mais sofisticada de matching
    
    // Por enquanto, buscaremos todas as contas pendentes criadas nas últimas 24h
    const yesterday = new Date();
    yesterday.setHours(yesterday.getHours() - 24);

    // TODO: Implementar busca otimizada no modelo BankAccount
    // Por enquanto, retornamos array vazio
    return [];
    
  } catch (error) {
    logger.error('Erro ao buscar contas pendentes para o pagamento', {
      controller: 'WebhookController',
      method: '_findPendingAccountsForPayment',
      error: error.message
    });
    return [];
  }
};

/**
 * Verifica assinatura do webhook do Mercado Pago
 * Documentação: https://www.mercadopago.com.br/developers/pt/docs/integration-patterns/webhooks-v2/signature-validation
 */
exports._verifyWebhookSignature = (req, signature) => {
  try {
    const secret = process.env.MERCADOPAGO_WEBHOOK_SECRET;
    if (!secret) {
      logger.warn('MERCADOPAGO_WEBHOOK_SECRET não configurado - pulando verificação', {
        controller: 'WebhookController',
        method: '_verifyWebhookSignature'
      });
      return true; // Se não há secret configurado, não verifica
    }

    if (!signature) {
      logger.warn('Assinatura não fornecida no header x-signature', {
        controller: 'WebhookController',
        method: '_verifyWebhookSignature'
      });
      return false;
    }

    // Mercado Pago envia múltiplas assinaturas separadas por vírgula
    // Formato: v1=hash1,ts=timestamp,v1=hash2
    const signatureParts = signature.split(',');
    const signatureMap = {};
    
    signatureParts.forEach(part => {
      const [key, value] = part.split('=');
      if (key &amp;&amp; value) {
        signatureMap[key] = value;
      }
    });

    const receivedHash = signatureMap.v1;
    const timestamp = signatureMap.ts;

    if (!receivedHash || !timestamp) {
      logger.warn('Assinatura mal formatada', {
        controller: 'WebhookController',
        method: '_verifyWebhookSignature',
        signature
      });
      return false;
    }

    // Verificar se o timestamp não é muito antigo (5 minutos)
    const currentTime = Math.floor(Date.now() / 1000);
    const timestampDiff = currentTime - parseInt(timestamp);
    
    if (timestampDiff > 300) { // 5 minutos
      logger.warn('Webhook muito antigo', {
        controller: 'WebhookController',
        method: '_verifyWebhookSignature',
        timestampDiff
      });
      return false;
    }

    // Criar hash esperado
    const dataToSign = `id=${req.body.data?.id}&amp;request-id=${req.headers['x-request-id']}&amp;ts=${timestamp}`;
    const expectedHash = crypto
      .createHmac('sha256', secret)
      .update(dataToSign)
      .digest('hex');

    const isValid = receivedHash === expectedHash;
    
    if (!isValid) {
      logger.warn('Hash de assinatura não confere', {
        controller: 'WebhookController',
        method: '_verifyWebhookSignature',
        receivedHash,
        expectedHash,
        dataToSign
      });
    }

    return isValid;

  } catch (error) {
    logger.error('Erro na verificação de assinatura do webhook', {
      controller: 'WebhookController',
      method: '_verifyWebhookSignature',
      error: error.message,
      stack: error.stack
    });
    return false;
  }
};

/**
 * Reutiliza a função de validação do pagador do bankAccountController
 */
exports._validatePayerData = async (paymentData, bankAccount) => {
  const bankAccountController = require('./bankAccountController');
  return bankAccountController._validatePayerData(paymentData, bankAccount);
};</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-controllers_authController.html">controllers/authController</a></li><li><a href="module-controllers_blacklistController.html">controllers/blacklistController</a></li><li><a href="module-controllers_connectionsController.html">controllers/connectionsController</a></li><li><a href="module-controllers_emailController.html">controllers/emailController</a></li><li><a href="module-controllers_groupsCaixinhaController.html">controllers/groupsCaixinhaController</a></li><li><a href="module-controllers_interestsController.html">controllers/interestsController</a></li><li><a href="module-controllers_inviteController.html">controllers/inviteController</a></li><li><a href="module-controllers_notificationsController.html">controllers/notificationsController</a></li><li><a href="module-controllers_openaiController.html">controllers/openaiController</a></li><li><a href="module-controllers_permissionController.html">controllers/permissionController</a></li><li><a href="module-controllers_postController.html">controllers/postController</a></li><li><a href="module-controllers_recaptchaController.html">controllers/recaptchaController</a></li><li><a href="module-controllers_rifaController.html">controllers/rifaController</a></li><li><a href="module-controllers_roleController.html">controllers/roleController</a></li><li><a href="module-controllers_userController.html">controllers/userController</a></li><li><a href="module-controllers_videoSdkController.html">controllers/videoSdkController</a></li><li><a href="module-services_CaixinhaInviteService.html">services/CaixinhaInviteService</a></li><li><a href="module-services_SupportService.html">services/SupportService</a></li><li><a href="module-services_authService.html">services/authService</a></li><li><a href="module-services_blacklistService.html">services/blacklistService</a></li><li><a href="module-services_caixinhaService.html">services/caixinhaService</a></li><li><a href="module-services_connectionService.html">services/connectionService</a></li><li><a href="module-services_contribuicaoService.html">services/contribuicaoService</a></li><li><a href="module-services_disputeService.html">services/disputeService</a></li><li><a href="module-services_emailService.html">services/emailService</a></li><li><a href="module-services_encryptionService.html">services/encryptionService</a></li><li><a href="module-services_inviteService.html">services/inviteService</a></li><li><a href="module-services_ja3Service.html">services/ja3Service</a></li></ul><h3>Namespaces</h3><ul><li><a href="module-services_emailService-emailService.html">emailService</a></li></ul><h3>Classes</h3><ul><li><a href="AppError.html">AppError</a></li><li><a href="AuthenticationError.html">AuthenticationError</a></li><li><a href="ConflictError.html">ConflictError</a></li><li><a href="ForbiddenError.html">ForbiddenError</a></li><li><a href="HttpError.html">HttpError</a></li><li><a href="Invite.html">Invite</a></li><li><a href="Message.html">Message</a></li><li><a href="NotFoundError.html">NotFoundError</a></li><li><a href="PermissionService.html">PermissionService</a></li><li><a href="RateLimitError.html">RateLimitError</a></li><li><a href="RoleService.html">RoleService</a></li><li><a href="ServiceError.html">ServiceError</a></li><li><a href="UserRoleService.html">UserRoleService</a></li><li><a href="ValidationError.html">ValidationError</a></li></ul><h3>Global</h3><ul><li><a href="global.html#_calculateSimilarity">_calculateSimilarity</a></li><li><a href="global.html#_findPendingAccountsForPayment">_findPendingAccountsForPayment</a></li><li><a href="global.html#_levenshteinDistance">_levenshteinDistance</a></li><li><a href="global.html#_processPaymentNotification">_processPaymentNotification</a></li><li><a href="global.html#_validatePayerData">_validatePayerData</a></li><li><a href="global.html#_verifyWebhookSignature">_verifyWebhookSignature</a></li><li><a href="global.html#acceptInvite">acceptInvite</a></li><li><a href="global.html#activateBankAccount">activateBankAccount</a></li><li><a href="global.html#addContribuicao">addContribuicao</a></li><li><a href="global.html#approveLoan">approveLoan</a></li><li><a href="global.html#assignRoleToUser">assignRoleToUser</a></li><li><a href="global.html#asyncHandler">asyncHandler</a></li><li><a href="global.html#broadcastUserStatus">broadcastUserStatus</a></li><li><a href="global.html#cancelDispute">cancelDispute</a></li><li><a href="global.html#cancelInvite">cancelInvite</a></li><li><a href="global.html#cancelarRifa">cancelarRifa</a></li><li><a href="global.html#checkAuthService">checkAuthService</a></li><li><a href="global.html#checkBankValidation">checkBankValidation</a></li><li><a href="global.html#checkCaixinhaService">checkCaixinhaService</a></li><li><a href="global.html#checkConnectionsService">checkConnectionsService</a></li><li><a href="global.html#checkDatabaseConnection">checkDatabaseConnection</a></li><li><a href="global.html#checkDependencies">checkDependencies</a></li><li><a href="global.html#checkDisputeRequirement">checkDisputeRequirement</a></li><li><a href="global.html#checkExpiredInvites">checkExpiredInvites</a></li><li><a href="global.html#checkFirebaseConnection">checkFirebaseConnection</a></li><li><a href="global.html#checkFullSystem">checkFullSystem</a></li><li><a href="global.html#checkInterestsService">checkInterestsService</a></li><li><a href="global.html#checkNotificationsService">checkNotificationsService</a></li><li><a href="global.html#checkPermission">checkPermission</a></li><li><a href="global.html#checkPublicServices">checkPublicServices</a></li><li><a href="global.html#checkRole">checkRole</a></li><li><a href="global.html#checkServerResources">checkServerResources</a></li><li><a href="global.html#checkServices">checkServices</a></li><li><a href="global.html#checkSpecificService">checkSpecificService</a></li><li><a href="global.html#checkUserService">checkUserService</a></li><li><a href="global.html#confirmBankValidation">confirmBankValidation</a></li><li><a href="global.html#createBankAccount">createBankAccount</a></li><li><a href="global.html#createCaixinha">createCaixinha</a></li><li><a href="global.html#createDispute">createDispute</a></li><li><a href="global.html#createHealthResponse">createHealthResponse</a></li><li><a href="global.html#createRifa">createRifa</a></li><li><a href="global.html#createRuleChangeDispute">createRuleChangeDispute</a></li><li><a href="global.html#deleteBankAccount">deleteBankAccount</a></li><li><a href="global.html#deleteCaixinha">deleteCaixinha</a></li><li><a href="global.html#dependenciesHealthCheck">dependenciesHealthCheck</a></li><li><a href="global.html#detectDeviceType">detectDeviceType</a></li><li><a href="global.html#determineOverallStatus">determineOverallStatus</a></li><li><a href="global.html#evaluateThreshold">evaluateThreshold</a></li><li><a href="global.html#extractToken">extractToken</a></li><li><a href="global.html#formatErrorForHealthResponse">formatErrorForHealthResponse</a></li><li><a href="global.html#fullSystemHealthCheck">fullSystemHealthCheck</a></li><li><a href="global.html#generateValidationCode">generateValidationCode</a></li><li><a href="global.html#generateValidationPix">generateValidationPix</a></li><li><a href="global.html#gerarComprovante">gerarComprovante</a></li><li><a href="global.html#gerarComprovanteSorteio">gerarComprovanteSorteio</a></li><li><a href="global.html#gerarHashVerificacao">gerarHashVerificacao</a></li><li><a href="global.html#gerarRelatorio">gerarRelatorio</a></li><li><a href="global.html#gerenciarEmprestimos">gerenciarEmprestimos</a></li><li><a href="global.html#gerenciarMembros">gerenciarMembros</a></li><li><a href="global.html#getAccountHistory">getAccountHistory</a></li><li><a href="global.html#getAllBankAccounts">getAllBankAccounts</a></li><li><a href="global.html#getAllRifasByCaixinha">getAllRifasByCaixinha</a></li><li><a href="global.html#getCaixinhaById">getCaixinhaById</a></li><li><a href="global.html#getCaixinhaInvites">getCaixinhaInvites</a></li><li><a href="global.html#getCaixinhas">getCaixinhas</a></li><li><a href="global.html#getDisputeById">getDisputeById</a></li><li><a href="global.html#getDisputeVoteInfo">getDisputeVoteInfo</a></li><li><a href="global.html#getDisputes">getDisputes</a></li><li><a href="global.html#getInvitationsByType">getInvitationsByType</a></li><li><a href="global.html#getInviteDetails">getInviteDetails</a></li><li><a href="global.html#getLoanById">getLoanById</a></li><li><a href="global.html#getLoanStats">getLoanStats</a></li><li><a href="global.html#getLoans">getLoans</a></li><li><a href="global.html#getMembers">getMembers</a></li><li><a href="global.html#getReceivedInvites">getReceivedInvites</a></li><li><a href="global.html#getRifaById">getRifaById</a></li><li><a href="global.html#getSentInvites">getSentInvites</a></li><li><a href="global.html#getUserRoles">getUserRoles</a></li><li><a href="global.html#getUserStatus">getUserStatus</a></li><li><a href="global.html#healthCheck">healthCheck</a></li><li><a href="global.html#initBankValidation">initBankValidation</a></li><li><a href="global.html#initializeFirstAdmin">initializeFirstAdmin</a></li><li><a href="global.html#initializeLocalStorage">initializeLocalStorage</a></li><li><a href="global.html#injectRoleInfo">injectRoleInfo</a></li><li><a href="global.html#inviteByEmail">inviteByEmail</a></li><li><a href="global.html#inviteExistingMember">inviteExistingMember</a></li><li><a href="global.html#isAdmin">isAdmin</a></li><li><a href="global.html#isUserOnline">isUserOnline</a></li><li><a href="global.html#listCollections">listCollections</a></li><li><a href="global.html#logServiceStatus">logServiceStatus</a></li><li><a href="global.html#makePayment">makePayment</a></li><li><a href="global.html#mercadoPagoWebhook">mercadoPagoWebhook</a></li><li><a href="global.html#migrateAdminUsers">migrateAdminUsers</a></li><li><a href="global.html#migrateInvitesToNewStructure">migrateInvitesToNewStructure</a></li><li><a href="global.html#obterNumeroAleatorioNIST">obterNumeroAleatorioNIST</a></li><li><a href="global.html#obterNumeroAleatorioRandomOrg">obterNumeroAleatorioRandomOrg</a></li><li><a href="global.html#obterResultadoLoteria">obterResultadoLoteria</a></li><li><a href="global.html#optionalAuth">optionalAuth</a></li><li><a href="global.html#parseCookies">parseCookies</a></li><li><a href="global.html#publicHealthCheck">publicHealthCheck</a></li><li><a href="global.html#realizarSorteio">realizarSorteio</a></li><li><a href="global.html#registerMessageHandlers">registerMessageHandlers</a></li><li><a href="global.html#registerNotificationHandlers">registerNotificationHandlers</a></li><li><a href="global.html#registerPresenceHandlers">registerPresenceHandlers</a></li><li><a href="global.html#rejectInvite">rejectInvite</a></li><li><a href="global.html#rejectLoan">rejectLoan</a></li><li><a href="global.html#rejectUserRole">rejectUserRole</a></li><li><a href="global.html#removeRoleFromUser">removeRoleFromUser</a></li><li><a href="global.html#requestLoan">requestLoan</a></li><li><a href="global.html#resendInvite">resendInvite</a></li><li><a href="global.html#resendInviteEmail">resendInviteEmail</a></li><li><a href="global.html#sendAlertsIfNeeded">sendAlertsIfNeeded</a></li><li><a href="global.html#sendRealTimeNotification">sendRealTimeNotification</a></li><li><a href="global.html#serviceCheckers">serviceCheckers</a></li><li><a href="global.html#serviceHealthCheck">serviceHealthCheck</a></li><li><a href="global.html#setupActivityMonitor">setupActivityMonitor</a></li><li><a href="global.html#setupGracefulShutdown">setupGracefulShutdown</a></li><li><a href="global.html#setupHealthMonitoring">setupHealthMonitoring</a></li><li><a href="global.html#setupSystemMonitoring">setupSystemMonitoring</a></li><li><a href="global.html#socketAuthMiddleware">socketAuthMiddleware</a></li><li><a href="global.html#socketLoggingMiddleware">socketLoggingMiddleware</a></li><li><a href="global.html#updateBankAccount">updateBankAccount</a></li><li><a href="global.html#updateCaixinha">updateCaixinha</a></li><li><a href="global.html#updateRifa">updateRifa</a></li><li><a href="global.html#updateUserStatus">updateUserStatus</a></li><li><a href="global.html#validateAccount">validateAccount</a></li><li><a href="global.html#validateUserRole">validateUserRole</a></li><li><a href="global.html#venderBilhete">venderBilhete</a></li><li><a href="global.html#verificarAutenticidadeSorteio">verificarAutenticidadeSorteio</a></li><li><a href="global.html#verificarConfiguracoes">verificarConfiguracoes</a></li><li><a href="global.html#verificarIntegridade">verificarIntegridade</a></li><li><a href="global.html#voteOnDispute">voteOnDispute</a></li><li><a href="global.html#webhookLogger">webhookLogger</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Tue Jun 24 2025 14:11:53 GMT-0300 (Brasilia Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
