<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: config/socket/handlers/messageHandlers.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: config/socket/handlers/messageHandlers.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * messageHandlers.js
 * Manipuladores de eventos relacionados a mensagens no sistema de socket.
 * Estes handlers processam eventos de socket relacionados a mensagens e interagem 
 * com o serviço de mensagens para executar a lógica de negócios.
 */

const { logger } = require('../../../logger');
const socketManager = require('../socketManager');
const { MESSAGE_EVENTS, CHAT_ROOM_EVENTS, TYPING_EVENTS } = require('../socketEvents');
const messageService = require('../../../services/messageService'); // Adapte ao caminho real do serviço

/**
 * Registra todos os handlers de mensagens para um socket
 * @param {SocketIO.Socket} socket - Socket do cliente
 * @param {string} userId - ID do usuário autenticado
 */
function registerMessageHandlers(socket, userId) {
  if (!socket || !userId) {
    logger.error('Tentativa de registrar handlers de mensagem sem socket ou userId válidos', {
      service: 'socket',
      function: 'registerMessageHandlers',
      socketId: socket?.id,
      userId
    });
    return;
  }

  // Handler para entrar em uma sala de chat (conversação)
  socket.on(CHAT_ROOM_EVENTS.JOIN_CHAT, async (conversationId) => {
    try {
      if (!conversationId) {
        socket.emit(CHAT_ROOM_EVENTS.JOIN_ERROR, { 
          error: 'ID de conversação inválido',
          conversationId 
        });
        return;
      }

      logger.info('Usuário entrando em sala de chat', {
        service: 'socket',
        function: 'joinChat',
        userId,
        conversationId
      });

      // Adicionar socket à sala do Socket.IO
      socket.join(conversationId);
      
      // Registrar usuário na sala via socketManager
      socketManager.addUserToRoom(userId, conversationId);
      
      // Marcar mensagens como lidas ao entrar na sala (opcional)
      try {
        await messageService.markMessagesAsRead(conversationId, userId);
        logger.info('Mensagens marcadas como lidas ao entrar na sala', {
            service: 'socket',
            function: 'joinChat',
            userId,
            conversationId
          });
      } catch (error) {
        logger.warn('Erro ao marcar mensagens como lidas', {
          service: 'socket',
          function: 'joinChat',
          userId,
          conversationId,
          error: error.message
        });
      }

      // Notificar sucesso ao cliente
      socket.emit(CHAT_ROOM_EVENTS.JOIN_SUCCESS, { conversationId });
      
      // Notificar outros na sala que o usuário entrou (opcional)
      socket.to(conversationId).emit(CHAT_ROOM_EVENTS.USER_JOINED, {
        userId,
        conversationId,
        timestamp: Date.now()
      });
    } catch (error) {
      logger.error('Erro ao processar join_chat', {
        service: 'socket',
        function: 'joinChat',
        userId,
        conversationId,
        error: error.message
      });
      
      socket.emit(CHAT_ROOM_EVENTS.JOIN_ERROR, {
        error: 'Erro ao entrar na sala',
        conversationId
      });
    }
  });

  // Handler para sair de uma sala de chat
  socket.on(CHAT_ROOM_EVENTS.LEAVE_CHAT, (conversationId) => {
    try {
      if (!conversationId) return;

      logger.info('Usuário saindo de sala de chat', {
        service: 'socket',
        function: 'leaveChat',
        userId,
        conversationId
      });

      // Remover socket da sala
      socket.leave(conversationId);
      
      // Remover usuário da sala via socketManager
      socketManager.removeUserFromRoom(userId, conversationId);
      
      // Notificar outros na sala que o usuário saiu (opcional)
      socket.to(conversationId).emit(CHAT_ROOM_EVENTS.USER_LEFT, {
        userId,
        conversationId,
        timestamp: Date.now()
      });
    } catch (error) {
      logger.error('Erro ao processar leave_chat', {
        service: 'socket',
        function: 'leaveChat',
        userId,
        conversationId,
        error: error.message
      });
    }
  });

  // Handler para receber e processar novas mensagens
  socket.on(MESSAGE_EVENTS.SEND_MESSAGE, async (messageData) => {
    try {
      // Validar dados da mensagem
      if (!messageData || !messageData.content || !messageData.recipient) {
        socket.emit(MESSAGE_EVENTS.MESSAGE_SEND_FAILED, {
          error: 'Dados da mensagem inválidos',
          temporaryId: messageData?.temporaryId
        });
        return;
      }

      logger.info('Nova mensagem recebida via socket', {
        service: 'socket',
        function: 'sendMessage',
        sender: userId,
        recipient: messageData.recipient,
        temporaryId: messageData.temporaryId
      });

      // Adicionar campos necessários à mensagem
      const enhancedMessage = {
        ...messageData,
        sender: userId,
        timestamp: messageData.timestamp || new Date().toISOString()
      };

      // Persistir a mensagem usando o serviço
      try {
        const savedMessage = await messageService.createMessage({
          uidDestinatario: messageData.recipient,
          conteudo: messageData.content,
          tipo: messageData.type || 'text'
        });

        // Determinar o ID da conversação (consistente com o frontend)
        const conversationId = [userId, messageData.recipient].sort().join('_');

        // Adaptar mensagem salva para o formato esperado pelo cliente
        const formattedMessage = {
          id: savedMessage.id,
          conversationId,
          sender: userId,
          recipient: messageData.recipient,
          content: savedMessage.conteudo,
          type: savedMessage.tipo,
          timestamp: savedMessage.timestamp,
          status: {
            delivered: true,
            read: false
          }
        };

        // Se houver um ID temporário, enviar evento de reconciliação
        if (messageData.temporaryId) {
          socket.emit(MESSAGE_EVENTS.RECONCILE_MESSAGE, {
            temporaryId: messageData.temporaryId,
            permanentMessage: formattedMessage
          });
        }

        // Emitir para todos os sockets na sala (incluindo o remetente para multi-dispositivos)
        socketManager.emitToRoom(conversationId, MESSAGE_EVENTS.NEW_MESSAGE, formattedMessage);

        // Registrar sucesso
        logger.info('Mensagem processada e distribuída com sucesso', {
          service: 'socket',
          function: 'sendMessage',
          messageId: savedMessage.id,
          conversationId
        });
      } catch (error) {
        logger.error('Erro ao salvar mensagem', {
          service: 'socket',
          function: 'sendMessage',
          error: error.message,
          messageData: enhancedMessage
        });

        // Notificar falha ao cliente
        socket.emit(MESSAGE_EVENTS.MESSAGE_SEND_FAILED, {
          error: 'Erro ao processar mensagem',
          temporaryId: messageData.temporaryId
        });
      }
    } catch (error) {
      logger.error('Erro ao processar evento send_message', {
        service: 'socket',
        function: 'sendMessage',
        userId,
        error: error.message
      });

      socket.emit(MESSAGE_EVENTS.MESSAGE_SEND_FAILED, {
        error: 'Erro interno ao processar mensagem',
        temporaryId: messageData?.temporaryId
      });
    }
  });

  // Handler para atualização de status de mensagem (lida, entregue)
  socket.on(MESSAGE_EVENTS.MESSAGE_STATUS_UPDATE, async (statusData) => {
    try {
      // Validar dados
      if (!statusData || !statusData.conversationId || !statusData.messageId || !statusData.status) {
        return;
      }

      logger.info('Atualização de status de mensagem recebida', {
        service: 'socket',
        function: 'updateMessageStatus',
        userId,
        messageId: statusData.messageId,
        status: statusData.status
      });

      // Atualizar status via serviço
      try {
        await messageService.updateMessageStatus(
          statusData.conversationId,
          statusData.messageId,
          { [statusData.status]: true }
        );

        // Transmitir atualização para todos na sala
        socketManager.emitToRoom(statusData.conversationId, MESSAGE_EVENTS.MESSAGE_STATUS_UPDATE, {
          conversationId: statusData.conversationId,
          messageId: statusData.messageId,
          status: statusData.status,
          updatedBy: userId,
          timestamp: Date.now()
        });
      } catch (error) {
        logger.error('Erro ao atualizar status da mensagem', {
          service: 'socket',
          function: 'updateMessageStatus',
          statusData,
          error: error.message
        });
      }
    } catch (error) {
      logger.error('Erro ao processar message_status_update', {
        service: 'socket',
        function: 'updateMessageStatus',
        userId,
        error: error.message
      });
    }
  });

  // Handler para exclusão de mensagem
  socket.on(MESSAGE_EVENTS.DELETE_MESSAGE, async (deleteData) => {
    try {
      // Validar dados
      if (!deleteData || !deleteData.conversationId || !deleteData.messageId) {
        return;
      }

      logger.info('Solicitação de exclusão de mensagem recebida', {
        service: 'socket',
        function: 'deleteMessage',
        userId,
        messageId: deleteData.messageId
      });

      // Verificar se o usuário tem permissão (deve ser o remetente da mensagem)
      try {
        // Executa lógica de autorização e exclusão
        await messageService.deleteMessage(
          deleteData.conversationId,
          deleteData.messageId
        );

        // Notificar todos na sala sobre a exclusão
        socketManager.emitToRoom(deleteData.conversationId, MESSAGE_EVENTS.MESSAGE_DELETED, {
          conversationId: deleteData.conversationId,
          messageId: deleteData.messageId,
          deletedBy: userId,
          timestamp: Date.now()
        });
      } catch (error) {
        logger.error('Erro ao excluir mensagem', {
          service: 'socket',
          function: 'deleteMessage',
          deleteData,
          error: error.message
        });

        // Opcional: notificar erro ao cliente
        socket.emit(MESSAGE_EVENTS.MESSAGE_DELETED, {
          error: 'Não foi possível excluir a mensagem',
          messageId: deleteData.messageId
        });
      }
    } catch (error) {
      logger.error('Erro ao processar delete_message', {
        service: 'socket',
        function: 'deleteMessage',
        userId,
        error: error.message
      });
    }
  });

  // Handler para status de digitação
  socket.on(TYPING_EVENTS.TYPING_STATUS, (typingData) => {
    try {
      // Validar dados
      if (!typingData || !typingData.conversationId) {
        return;
      }

      const isTyping = typingData.isTyping === true;

      // Registrar em log com nível mais baixo (pode gerar muitos logs)
      logger.debug('Atualização de status de digitação', {
        service: 'socket',
        function: 'typingStatus',
        userId,
        conversationId: typingData.conversationId,
        isTyping
      });

      // Transmitir para outros na sala
      socket.to(typingData.conversationId).emit(TYPING_EVENTS.TYPING_STATUS, {
        senderId: userId,
        conversationId: typingData.conversationId,
        isTyping,
        timestamp: Date.now()
      });
    } catch (error) {
      logger.error('Erro ao processar typing_status', {
        service: 'socket',
        function: 'typingStatus',
        userId,
        error: error.message
      });
    }
  });
}

module.exports = registerMessageHandlers;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-controllers_authController.html">controllers/authController</a></li><li><a href="module-controllers_blacklistController.html">controllers/blacklistController</a></li><li><a href="module-controllers_connectionsController.html">controllers/connectionsController</a></li><li><a href="module-controllers_emailController.html">controllers/emailController</a></li><li><a href="module-controllers_groupsCaixinhaController.html">controllers/groupsCaixinhaController</a></li><li><a href="module-controllers_interestsController.html">controllers/interestsController</a></li><li><a href="module-controllers_inviteController.html">controllers/inviteController</a></li><li><a href="module-controllers_notificationsController.html">controllers/notificationsController</a></li><li><a href="module-controllers_openaiController.html">controllers/openaiController</a></li><li><a href="module-controllers_permissionController.html">controllers/permissionController</a></li><li><a href="module-controllers_postController.html">controllers/postController</a></li><li><a href="module-controllers_recaptchaController.html">controllers/recaptchaController</a></li><li><a href="module-controllers_rifaController.html">controllers/rifaController</a></li><li><a href="module-controllers_roleController.html">controllers/roleController</a></li><li><a href="module-controllers_userController.html">controllers/userController</a></li><li><a href="module-controllers_videoSdkController.html">controllers/videoSdkController</a></li><li><a href="module-services_CaixinhaInviteService.html">services/CaixinhaInviteService</a></li><li><a href="module-services_SupportService.html">services/SupportService</a></li><li><a href="module-services_authService.html">services/authService</a></li><li><a href="module-services_blacklistService.html">services/blacklistService</a></li><li><a href="module-services_caixinhaService.html">services/caixinhaService</a></li><li><a href="module-services_connectionService.html">services/connectionService</a></li><li><a href="module-services_contribuicaoService.html">services/contribuicaoService</a></li><li><a href="module-services_disputeService.html">services/disputeService</a></li><li><a href="module-services_emailService.html">services/emailService</a></li><li><a href="module-services_encryptionService.html">services/encryptionService</a></li><li><a href="module-services_inviteService.html">services/inviteService</a></li><li><a href="module-services_ja3Service.html">services/ja3Service</a></li></ul><h3>Namespaces</h3><ul><li><a href="module-services_emailService-emailService.html">emailService</a></li></ul><h3>Classes</h3><ul><li><a href="AppError.html">AppError</a></li><li><a href="AuthenticationError.html">AuthenticationError</a></li><li><a href="ConflictError.html">ConflictError</a></li><li><a href="ForbiddenError.html">ForbiddenError</a></li><li><a href="HttpError.html">HttpError</a></li><li><a href="Invite.html">Invite</a></li><li><a href="Message.html">Message</a></li><li><a href="NotFoundError.html">NotFoundError</a></li><li><a href="PermissionService.html">PermissionService</a></li><li><a href="RateLimitError.html">RateLimitError</a></li><li><a href="RoleService.html">RoleService</a></li><li><a href="ServiceError.html">ServiceError</a></li><li><a href="UserRoleService.html">UserRoleService</a></li><li><a href="ValidationError.html">ValidationError</a></li></ul><h3>Global</h3><ul><li><a href="global.html#_calculateSimilarity">_calculateSimilarity</a></li><li><a href="global.html#_findPendingAccountsForPayment">_findPendingAccountsForPayment</a></li><li><a href="global.html#_levenshteinDistance">_levenshteinDistance</a></li><li><a href="global.html#_processPaymentNotification">_processPaymentNotification</a></li><li><a href="global.html#_validatePayerData">_validatePayerData</a></li><li><a href="global.html#_verifyWebhookSignature">_verifyWebhookSignature</a></li><li><a href="global.html#acceptInvite">acceptInvite</a></li><li><a href="global.html#activateBankAccount">activateBankAccount</a></li><li><a href="global.html#addContribuicao">addContribuicao</a></li><li><a href="global.html#approveLoan">approveLoan</a></li><li><a href="global.html#assignRoleToUser">assignRoleToUser</a></li><li><a href="global.html#asyncHandler">asyncHandler</a></li><li><a href="global.html#broadcastUserStatus">broadcastUserStatus</a></li><li><a href="global.html#cancelDispute">cancelDispute</a></li><li><a href="global.html#cancelInvite">cancelInvite</a></li><li><a href="global.html#cancelarRifa">cancelarRifa</a></li><li><a href="global.html#checkAuthService">checkAuthService</a></li><li><a href="global.html#checkBankValidation">checkBankValidation</a></li><li><a href="global.html#checkCaixinhaService">checkCaixinhaService</a></li><li><a href="global.html#checkConnectionsService">checkConnectionsService</a></li><li><a href="global.html#checkDatabaseConnection">checkDatabaseConnection</a></li><li><a href="global.html#checkDependencies">checkDependencies</a></li><li><a href="global.html#checkDisputeRequirement">checkDisputeRequirement</a></li><li><a href="global.html#checkExpiredInvites">checkExpiredInvites</a></li><li><a href="global.html#checkFirebaseConnection">checkFirebaseConnection</a></li><li><a href="global.html#checkFullSystem">checkFullSystem</a></li><li><a href="global.html#checkInterestsService">checkInterestsService</a></li><li><a href="global.html#checkNotificationsService">checkNotificationsService</a></li><li><a href="global.html#checkPermission">checkPermission</a></li><li><a href="global.html#checkPublicServices">checkPublicServices</a></li><li><a href="global.html#checkRole">checkRole</a></li><li><a href="global.html#checkServerResources">checkServerResources</a></li><li><a href="global.html#checkServices">checkServices</a></li><li><a href="global.html#checkSpecificService">checkSpecificService</a></li><li><a href="global.html#checkUserService">checkUserService</a></li><li><a href="global.html#confirmBankValidation">confirmBankValidation</a></li><li><a href="global.html#createBankAccount">createBankAccount</a></li><li><a href="global.html#createCaixinha">createCaixinha</a></li><li><a href="global.html#createDispute">createDispute</a></li><li><a href="global.html#createHealthResponse">createHealthResponse</a></li><li><a href="global.html#createRifa">createRifa</a></li><li><a href="global.html#createRuleChangeDispute">createRuleChangeDispute</a></li><li><a href="global.html#deleteBankAccount">deleteBankAccount</a></li><li><a href="global.html#deleteCaixinha">deleteCaixinha</a></li><li><a href="global.html#dependenciesHealthCheck">dependenciesHealthCheck</a></li><li><a href="global.html#detectDeviceType">detectDeviceType</a></li><li><a href="global.html#determineOverallStatus">determineOverallStatus</a></li><li><a href="global.html#evaluateThreshold">evaluateThreshold</a></li><li><a href="global.html#extractToken">extractToken</a></li><li><a href="global.html#formatErrorForHealthResponse">formatErrorForHealthResponse</a></li><li><a href="global.html#fullSystemHealthCheck">fullSystemHealthCheck</a></li><li><a href="global.html#generateValidationCode">generateValidationCode</a></li><li><a href="global.html#generateValidationPix">generateValidationPix</a></li><li><a href="global.html#gerarComprovante">gerarComprovante</a></li><li><a href="global.html#gerarComprovanteSorteio">gerarComprovanteSorteio</a></li><li><a href="global.html#gerarHashVerificacao">gerarHashVerificacao</a></li><li><a href="global.html#gerarRelatorio">gerarRelatorio</a></li><li><a href="global.html#gerenciarEmprestimos">gerenciarEmprestimos</a></li><li><a href="global.html#gerenciarMembros">gerenciarMembros</a></li><li><a href="global.html#getAccountHistory">getAccountHistory</a></li><li><a href="global.html#getAllBankAccounts">getAllBankAccounts</a></li><li><a href="global.html#getAllRifasByCaixinha">getAllRifasByCaixinha</a></li><li><a href="global.html#getCaixinhaById">getCaixinhaById</a></li><li><a href="global.html#getCaixinhaInvites">getCaixinhaInvites</a></li><li><a href="global.html#getCaixinhas">getCaixinhas</a></li><li><a href="global.html#getDisputeById">getDisputeById</a></li><li><a href="global.html#getDisputeVoteInfo">getDisputeVoteInfo</a></li><li><a href="global.html#getDisputes">getDisputes</a></li><li><a href="global.html#getInvitationsByType">getInvitationsByType</a></li><li><a href="global.html#getInviteDetails">getInviteDetails</a></li><li><a href="global.html#getLoanById">getLoanById</a></li><li><a href="global.html#getLoanStats">getLoanStats</a></li><li><a href="global.html#getLoans">getLoans</a></li><li><a href="global.html#getMembers">getMembers</a></li><li><a href="global.html#getReceivedInvites">getReceivedInvites</a></li><li><a href="global.html#getRifaById">getRifaById</a></li><li><a href="global.html#getSentInvites">getSentInvites</a></li><li><a href="global.html#getUserRoles">getUserRoles</a></li><li><a href="global.html#getUserStatus">getUserStatus</a></li><li><a href="global.html#healthCheck">healthCheck</a></li><li><a href="global.html#initBankValidation">initBankValidation</a></li><li><a href="global.html#initializeFirstAdmin">initializeFirstAdmin</a></li><li><a href="global.html#initializeLocalStorage">initializeLocalStorage</a></li><li><a href="global.html#injectRoleInfo">injectRoleInfo</a></li><li><a href="global.html#inviteByEmail">inviteByEmail</a></li><li><a href="global.html#inviteExistingMember">inviteExistingMember</a></li><li><a href="global.html#isAdmin">isAdmin</a></li><li><a href="global.html#isUserOnline">isUserOnline</a></li><li><a href="global.html#listCollections">listCollections</a></li><li><a href="global.html#logServiceStatus">logServiceStatus</a></li><li><a href="global.html#makePayment">makePayment</a></li><li><a href="global.html#mercadoPagoWebhook">mercadoPagoWebhook</a></li><li><a href="global.html#migrateAdminUsers">migrateAdminUsers</a></li><li><a href="global.html#migrateInvitesToNewStructure">migrateInvitesToNewStructure</a></li><li><a href="global.html#obterNumeroAleatorioNIST">obterNumeroAleatorioNIST</a></li><li><a href="global.html#obterNumeroAleatorioRandomOrg">obterNumeroAleatorioRandomOrg</a></li><li><a href="global.html#obterResultadoLoteria">obterResultadoLoteria</a></li><li><a href="global.html#optionalAuth">optionalAuth</a></li><li><a href="global.html#parseCookies">parseCookies</a></li><li><a href="global.html#publicHealthCheck">publicHealthCheck</a></li><li><a href="global.html#realizarSorteio">realizarSorteio</a></li><li><a href="global.html#registerMessageHandlers">registerMessageHandlers</a></li><li><a href="global.html#registerNotificationHandlers">registerNotificationHandlers</a></li><li><a href="global.html#registerPresenceHandlers">registerPresenceHandlers</a></li><li><a href="global.html#rejectInvite">rejectInvite</a></li><li><a href="global.html#rejectLoan">rejectLoan</a></li><li><a href="global.html#rejectUserRole">rejectUserRole</a></li><li><a href="global.html#removeRoleFromUser">removeRoleFromUser</a></li><li><a href="global.html#requestLoan">requestLoan</a></li><li><a href="global.html#resendInvite">resendInvite</a></li><li><a href="global.html#resendInviteEmail">resendInviteEmail</a></li><li><a href="global.html#sendAlertsIfNeeded">sendAlertsIfNeeded</a></li><li><a href="global.html#sendRealTimeNotification">sendRealTimeNotification</a></li><li><a href="global.html#serviceCheckers">serviceCheckers</a></li><li><a href="global.html#serviceHealthCheck">serviceHealthCheck</a></li><li><a href="global.html#setupActivityMonitor">setupActivityMonitor</a></li><li><a href="global.html#setupGracefulShutdown">setupGracefulShutdown</a></li><li><a href="global.html#setupHealthMonitoring">setupHealthMonitoring</a></li><li><a href="global.html#setupSystemMonitoring">setupSystemMonitoring</a></li><li><a href="global.html#socketAuthMiddleware">socketAuthMiddleware</a></li><li><a href="global.html#socketLoggingMiddleware">socketLoggingMiddleware</a></li><li><a href="global.html#updateBankAccount">updateBankAccount</a></li><li><a href="global.html#updateCaixinha">updateCaixinha</a></li><li><a href="global.html#updateRifa">updateRifa</a></li><li><a href="global.html#updateUserStatus">updateUserStatus</a></li><li><a href="global.html#validateAccount">validateAccount</a></li><li><a href="global.html#validateUserRole">validateUserRole</a></li><li><a href="global.html#venderBilhete">venderBilhete</a></li><li><a href="global.html#verificarAutenticidadeSorteio">verificarAutenticidadeSorteio</a></li><li><a href="global.html#verificarConfiguracoes">verificarConfiguracoes</a></li><li><a href="global.html#verificarIntegridade">verificarIntegridade</a></li><li><a href="global.html#voteOnDispute">voteOnDispute</a></li><li><a href="global.html#webhookLogger">webhookLogger</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Tue Jun 24 2025 14:11:53 GMT-0300 (Brasilia Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
