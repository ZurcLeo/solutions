<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: services/roleService.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: services/roleService.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// services/roleService.js
const { logger } = require('../logger');
const Role = require('../models/Role');
const RolePermission = require('../models/RolePermission');
const UserRole = require('../models/UserRole');

/**
 * Serviço para gerenciamento de roles do sistema
 */
class RoleService {
  /**
   * Cria uma nova role
   * @param {Object} roleData - Dados da role a ser criada
   * @returns {Promise&lt;Role>} A role criada
   */
  async createRole(roleData) {
    logger.info('Criando nova role', {
      service: 'roleService',
      function: 'createRole',
      roleName: roleData.name
    });
    
    try {
      return await Role.create(roleData);
    } catch (error) {
      logger.error('Erro ao criar role', {
        service: 'roleService',
        function: 'createRole',
        error: error.message,
        roleData
      });
      throw error;
    }
  }

  /**
   * Atualiza uma role existente
   * @param {string} roleId - ID da role a ser atualizada
   * @param {Object} roleData - Novos dados da role
   * @returns {Promise&lt;Role>} A role atualizada
   */
  async updateRole(roleId, roleData) {
    logger.info('Atualizando role', {
      service: 'roleService',
      function: 'updateRole',
      roleId
    });
    
    try {
      return await Role.update(roleId, roleData);
    } catch (error) {
      logger.error('Erro ao atualizar role', {
        service: 'roleService',
        function: 'updateRole',
        roleId,
        error: error.message,
        roleData
      });
      throw error;
    }
  }

  /**
   * Remove uma role
   * @param {string} roleId - ID da role a ser removida
   * @returns {Promise&lt;boolean>} Sucesso da operação
   */
  async deleteRole(roleId) {
    logger.info('Removendo role', {
      service: 'roleService',
      function: 'deleteRole',
      roleId
    });
    
    try {
      // Verificar se a role está em uso
      const isInUse = await this.isRoleInUse(roleId);
      
      if (isInUse) {
        throw new Error('Não é possível remover uma role que está em uso por usuários');
      }
      
      // Remover todas as associações de permissões
      const rolePermissions = await RolePermission.getByRoleId(roleId);
      for (const rp of rolePermissions) {
        await RolePermission.removePermissionFromRole(roleId, rp.permissionId);
      }
      
      // Remover a role
      return await Role.delete(roleId);
    } catch (error) {
      logger.error('Erro ao remover role', {
        service: 'roleService',
        function: 'deleteRole',
        roleId,
        error: error.message
      });
      throw error;
    }
  }

  /**
   * Obtém todas as roles com filtros opcionais
   * @param {Object} filters - Filtros opcionais
   * @returns {Promise&lt;Array&lt;Role>>} Lista de roles
   */
  async getRoles(filters = {}) {
    logger.info('Buscando roles', {
      service: 'roleService',
      function: 'getRoles',
      filters
    });
    
    try {
      const roles = await Role.findAll();
      
      // Aplicar filtros em memória (se necessário)
      let filteredRoles = roles;
      
      if (filters.isSystemRole !== undefined) {
        filteredRoles = filteredRoles.filter(role => 
          role.isSystemRole === filters.isSystemRole
        );
      }
      
      if (filters.name) {
        const nameFilter = filters.name.toLowerCase();
        filteredRoles = filteredRoles.filter(role => 
          role.name.toLowerCase().includes(nameFilter)
        );
      }
      
      return filteredRoles;
    } catch (error) {
      logger.error('Erro ao buscar roles', {
        service: 'roleService',
        function: 'getRoles',
        error: error.message,
        filters
      });
      throw error;
    }
  }

  /**
   * Obtém uma role pelo ID
   * @param {string} roleId - ID da role
   * @returns {Promise&lt;Role>} A role encontrada
   */
  async getRoleById(roleId) {
    logger.info('Buscando role por ID', {
      service: 'roleService',
      function: 'getRoleById',
      roleId
    });
    
    try {
      return await Role.getById(roleId);
    } catch (error) {
      logger.error('Erro ao buscar role por ID', {
        service: 'roleService',
        function: 'getRoleById',
        roleId,
        error: error.message
      });
      throw error;
    }
  }

  /**
   * Obtém as permissões associadas a uma role
   * @param {string} roleId - ID da role
   * @returns {Promise&lt;Array&lt;Permission>>} Lista de permissões
   */
  async getRolePermissions(roleId) {
    logger.info('Buscando permissões da role', {
      service: 'roleService',
      function: 'getRolePermissions',
      roleId
    });
    
    try {
      return await RolePermission.getRolePermissions(roleId);
    } catch (error) {
      logger.error('Erro ao buscar permissões da role', {
        service: 'roleService',
        function: 'getRolePermissions',
        roleId,
        error: error.message
      });
      throw error;
    }
  }

  /**
   * Verifica se uma role está sendo usada por algum usuário
   * @param {string} roleId - ID da role
   * @returns {Promise&lt;boolean>} True se a role estiver em uso
   */
  async isRoleInUse(roleId) {
    try {
      // Buscar no Firestore se há algum documento UserRole com esta roleId
      const db = require('../firebaseAdmin').getFirestore();
      const snapshot = await db.collection('user_roles')
        .where('roleId', '==', roleId)
        .limit(1)
        .get();
      
      return !snapshot.empty;
    } catch (error) {
      logger.error('Erro ao verificar se role está em uso', {
        service: 'roleService',
        function: 'isRoleInUse',
        roleId,
        error: error.message
      });
      throw error;
    }
  }

  /**
   * Inicializa as roles padrão do sistema
   * @returns {Promise&lt;void>}
   */
  async initializeDefaultRoles() {
    logger.info('Inicializando roles padrão do sistema', {
      service: 'roleService',
      function: 'initializeDefaultRoles'
    });
    
    try {
      // Obter roles do initialData
      const { roles } = require('../config/data/initialData');
      
      // Buscar roles existentes
      const existingRoles = await Role.findAll();
      const existingRoleNames = existingRoles.map(role => role.name);
      
      // Criar apenas as roles que não existem
      for (const roleId in roles) {
        const roleData = roles[roleId];
        if (!existingRoleNames.includes(roleData.name)) {
          await Role.create({
            id: roleId,  // Usar o ID do mapa como ID da role
            name: roleData.name,
            description: roleData.description,
            isSystemRole: roleData.isSystemRole
          });
          
          logger.info(`Role padrão criada: ${roleData.name}`, {
            service: 'roleService',
            function: 'initializeDefaultRoles'
          });
        }
      }
      
      logger.info('Inicialização de roles padrão concluída', {
        service: 'roleService',
        function: 'initializeDefaultRoles'
      });
    } catch (error) {
      logger.error('Erro ao inicializar roles padrão', {
        service: 'roleService',
        function: 'initializeDefaultRoles',
        error: error.message
      });
      throw error;
    }
  }
  
}

module.exports = new RoleService();</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-controllers_authController.html">controllers/authController</a></li><li><a href="module-controllers_blacklistController.html">controllers/blacklistController</a></li><li><a href="module-controllers_connectionsController.html">controllers/connectionsController</a></li><li><a href="module-controllers_emailController.html">controllers/emailController</a></li><li><a href="module-controllers_groupsCaixinhaController.html">controllers/groupsCaixinhaController</a></li><li><a href="module-controllers_interestsController.html">controllers/interestsController</a></li><li><a href="module-controllers_inviteController.html">controllers/inviteController</a></li><li><a href="module-controllers_notificationsController.html">controllers/notificationsController</a></li><li><a href="module-controllers_openaiController.html">controllers/openaiController</a></li><li><a href="module-controllers_permissionController.html">controllers/permissionController</a></li><li><a href="module-controllers_postController.html">controllers/postController</a></li><li><a href="module-controllers_recaptchaController.html">controllers/recaptchaController</a></li><li><a href="module-controllers_rifaController.html">controllers/rifaController</a></li><li><a href="module-controllers_roleController.html">controllers/roleController</a></li><li><a href="module-controllers_userController.html">controllers/userController</a></li><li><a href="module-controllers_videoSdkController.html">controllers/videoSdkController</a></li><li><a href="module-services_CaixinhaInviteService.html">services/CaixinhaInviteService</a></li><li><a href="module-services_SupportService.html">services/SupportService</a></li><li><a href="module-services_authService.html">services/authService</a></li><li><a href="module-services_blacklistService.html">services/blacklistService</a></li><li><a href="module-services_caixinhaService.html">services/caixinhaService</a></li><li><a href="module-services_connectionService.html">services/connectionService</a></li><li><a href="module-services_contribuicaoService.html">services/contribuicaoService</a></li><li><a href="module-services_disputeService.html">services/disputeService</a></li><li><a href="module-services_emailService.html">services/emailService</a></li><li><a href="module-services_encryptionService.html">services/encryptionService</a></li><li><a href="module-services_inviteService.html">services/inviteService</a></li><li><a href="module-services_ja3Service.html">services/ja3Service</a></li></ul><h3>Namespaces</h3><ul><li><a href="module-services_emailService-emailService.html">emailService</a></li></ul><h3>Classes</h3><ul><li><a href="AppError.html">AppError</a></li><li><a href="AuthenticationError.html">AuthenticationError</a></li><li><a href="ConflictError.html">ConflictError</a></li><li><a href="ForbiddenError.html">ForbiddenError</a></li><li><a href="HttpError.html">HttpError</a></li><li><a href="Invite.html">Invite</a></li><li><a href="Message.html">Message</a></li><li><a href="NotFoundError.html">NotFoundError</a></li><li><a href="PermissionService.html">PermissionService</a></li><li><a href="RateLimitError.html">RateLimitError</a></li><li><a href="RoleService.html">RoleService</a></li><li><a href="ServiceError.html">ServiceError</a></li><li><a href="UserRoleService.html">UserRoleService</a></li><li><a href="ValidationError.html">ValidationError</a></li></ul><h3>Global</h3><ul><li><a href="global.html#_calculateSimilarity">_calculateSimilarity</a></li><li><a href="global.html#_findPendingAccountsForPayment">_findPendingAccountsForPayment</a></li><li><a href="global.html#_levenshteinDistance">_levenshteinDistance</a></li><li><a href="global.html#_processPaymentNotification">_processPaymentNotification</a></li><li><a href="global.html#_validatePayerData">_validatePayerData</a></li><li><a href="global.html#_verifyWebhookSignature">_verifyWebhookSignature</a></li><li><a href="global.html#acceptInvite">acceptInvite</a></li><li><a href="global.html#activateBankAccount">activateBankAccount</a></li><li><a href="global.html#addContribuicao">addContribuicao</a></li><li><a href="global.html#approveLoan">approveLoan</a></li><li><a href="global.html#assignRoleToUser">assignRoleToUser</a></li><li><a href="global.html#asyncHandler">asyncHandler</a></li><li><a href="global.html#broadcastUserStatus">broadcastUserStatus</a></li><li><a href="global.html#cancelDispute">cancelDispute</a></li><li><a href="global.html#cancelInvite">cancelInvite</a></li><li><a href="global.html#cancelarRifa">cancelarRifa</a></li><li><a href="global.html#checkAuthService">checkAuthService</a></li><li><a href="global.html#checkBankValidation">checkBankValidation</a></li><li><a href="global.html#checkCaixinhaService">checkCaixinhaService</a></li><li><a href="global.html#checkConnectionsService">checkConnectionsService</a></li><li><a href="global.html#checkDatabaseConnection">checkDatabaseConnection</a></li><li><a href="global.html#checkDependencies">checkDependencies</a></li><li><a href="global.html#checkDisputeRequirement">checkDisputeRequirement</a></li><li><a href="global.html#checkExpiredInvites">checkExpiredInvites</a></li><li><a href="global.html#checkFirebaseConnection">checkFirebaseConnection</a></li><li><a href="global.html#checkFullSystem">checkFullSystem</a></li><li><a href="global.html#checkInterestsService">checkInterestsService</a></li><li><a href="global.html#checkNotificationsService">checkNotificationsService</a></li><li><a href="global.html#checkPermission">checkPermission</a></li><li><a href="global.html#checkPublicServices">checkPublicServices</a></li><li><a href="global.html#checkRole">checkRole</a></li><li><a href="global.html#checkServerResources">checkServerResources</a></li><li><a href="global.html#checkServices">checkServices</a></li><li><a href="global.html#checkSpecificService">checkSpecificService</a></li><li><a href="global.html#checkUserService">checkUserService</a></li><li><a href="global.html#confirmBankValidation">confirmBankValidation</a></li><li><a href="global.html#createBankAccount">createBankAccount</a></li><li><a href="global.html#createCaixinha">createCaixinha</a></li><li><a href="global.html#createDispute">createDispute</a></li><li><a href="global.html#createHealthResponse">createHealthResponse</a></li><li><a href="global.html#createRifa">createRifa</a></li><li><a href="global.html#createRuleChangeDispute">createRuleChangeDispute</a></li><li><a href="global.html#deleteBankAccount">deleteBankAccount</a></li><li><a href="global.html#deleteCaixinha">deleteCaixinha</a></li><li><a href="global.html#dependenciesHealthCheck">dependenciesHealthCheck</a></li><li><a href="global.html#detectDeviceType">detectDeviceType</a></li><li><a href="global.html#determineOverallStatus">determineOverallStatus</a></li><li><a href="global.html#evaluateThreshold">evaluateThreshold</a></li><li><a href="global.html#extractToken">extractToken</a></li><li><a href="global.html#formatErrorForHealthResponse">formatErrorForHealthResponse</a></li><li><a href="global.html#fullSystemHealthCheck">fullSystemHealthCheck</a></li><li><a href="global.html#generateValidationCode">generateValidationCode</a></li><li><a href="global.html#generateValidationPix">generateValidationPix</a></li><li><a href="global.html#gerarComprovante">gerarComprovante</a></li><li><a href="global.html#gerarComprovanteSorteio">gerarComprovanteSorteio</a></li><li><a href="global.html#gerarHashVerificacao">gerarHashVerificacao</a></li><li><a href="global.html#gerarRelatorio">gerarRelatorio</a></li><li><a href="global.html#gerenciarEmprestimos">gerenciarEmprestimos</a></li><li><a href="global.html#gerenciarMembros">gerenciarMembros</a></li><li><a href="global.html#getAccountHistory">getAccountHistory</a></li><li><a href="global.html#getAllBankAccounts">getAllBankAccounts</a></li><li><a href="global.html#getAllRifasByCaixinha">getAllRifasByCaixinha</a></li><li><a href="global.html#getCaixinhaById">getCaixinhaById</a></li><li><a href="global.html#getCaixinhaInvites">getCaixinhaInvites</a></li><li><a href="global.html#getCaixinhas">getCaixinhas</a></li><li><a href="global.html#getDisputeById">getDisputeById</a></li><li><a href="global.html#getDisputeVoteInfo">getDisputeVoteInfo</a></li><li><a href="global.html#getDisputes">getDisputes</a></li><li><a href="global.html#getInvitationsByType">getInvitationsByType</a></li><li><a href="global.html#getInviteDetails">getInviteDetails</a></li><li><a href="global.html#getLoanById">getLoanById</a></li><li><a href="global.html#getLoanStats">getLoanStats</a></li><li><a href="global.html#getLoans">getLoans</a></li><li><a href="global.html#getMembers">getMembers</a></li><li><a href="global.html#getReceivedInvites">getReceivedInvites</a></li><li><a href="global.html#getRifaById">getRifaById</a></li><li><a href="global.html#getSentInvites">getSentInvites</a></li><li><a href="global.html#getUserRoles">getUserRoles</a></li><li><a href="global.html#getUserStatus">getUserStatus</a></li><li><a href="global.html#healthCheck">healthCheck</a></li><li><a href="global.html#initBankValidation">initBankValidation</a></li><li><a href="global.html#initializeFirstAdmin">initializeFirstAdmin</a></li><li><a href="global.html#initializeLocalStorage">initializeLocalStorage</a></li><li><a href="global.html#injectRoleInfo">injectRoleInfo</a></li><li><a href="global.html#inviteByEmail">inviteByEmail</a></li><li><a href="global.html#inviteExistingMember">inviteExistingMember</a></li><li><a href="global.html#isAdmin">isAdmin</a></li><li><a href="global.html#isUserOnline">isUserOnline</a></li><li><a href="global.html#listCollections">listCollections</a></li><li><a href="global.html#logServiceStatus">logServiceStatus</a></li><li><a href="global.html#makePayment">makePayment</a></li><li><a href="global.html#mercadoPagoWebhook">mercadoPagoWebhook</a></li><li><a href="global.html#migrateAdminUsers">migrateAdminUsers</a></li><li><a href="global.html#migrateInvitesToNewStructure">migrateInvitesToNewStructure</a></li><li><a href="global.html#obterNumeroAleatorioNIST">obterNumeroAleatorioNIST</a></li><li><a href="global.html#obterNumeroAleatorioRandomOrg">obterNumeroAleatorioRandomOrg</a></li><li><a href="global.html#obterResultadoLoteria">obterResultadoLoteria</a></li><li><a href="global.html#optionalAuth">optionalAuth</a></li><li><a href="global.html#parseCookies">parseCookies</a></li><li><a href="global.html#publicHealthCheck">publicHealthCheck</a></li><li><a href="global.html#realizarSorteio">realizarSorteio</a></li><li><a href="global.html#registerMessageHandlers">registerMessageHandlers</a></li><li><a href="global.html#registerNotificationHandlers">registerNotificationHandlers</a></li><li><a href="global.html#registerPresenceHandlers">registerPresenceHandlers</a></li><li><a href="global.html#rejectInvite">rejectInvite</a></li><li><a href="global.html#rejectLoan">rejectLoan</a></li><li><a href="global.html#rejectUserRole">rejectUserRole</a></li><li><a href="global.html#removeRoleFromUser">removeRoleFromUser</a></li><li><a href="global.html#requestLoan">requestLoan</a></li><li><a href="global.html#resendInvite">resendInvite</a></li><li><a href="global.html#resendInviteEmail">resendInviteEmail</a></li><li><a href="global.html#sendAlertsIfNeeded">sendAlertsIfNeeded</a></li><li><a href="global.html#sendRealTimeNotification">sendRealTimeNotification</a></li><li><a href="global.html#serviceCheckers">serviceCheckers</a></li><li><a href="global.html#serviceHealthCheck">serviceHealthCheck</a></li><li><a href="global.html#setupActivityMonitor">setupActivityMonitor</a></li><li><a href="global.html#setupGracefulShutdown">setupGracefulShutdown</a></li><li><a href="global.html#setupHealthMonitoring">setupHealthMonitoring</a></li><li><a href="global.html#setupSystemMonitoring">setupSystemMonitoring</a></li><li><a href="global.html#socketAuthMiddleware">socketAuthMiddleware</a></li><li><a href="global.html#socketLoggingMiddleware">socketLoggingMiddleware</a></li><li><a href="global.html#updateBankAccount">updateBankAccount</a></li><li><a href="global.html#updateCaixinha">updateCaixinha</a></li><li><a href="global.html#updateRifa">updateRifa</a></li><li><a href="global.html#updateUserStatus">updateUserStatus</a></li><li><a href="global.html#validateAccount">validateAccount</a></li><li><a href="global.html#validateUserRole">validateUserRole</a></li><li><a href="global.html#venderBilhete">venderBilhete</a></li><li><a href="global.html#verificarAutenticidadeSorteio">verificarAutenticidadeSorteio</a></li><li><a href="global.html#verificarConfiguracoes">verificarConfiguracoes</a></li><li><a href="global.html#verificarIntegridade">verificarIntegridade</a></li><li><a href="global.html#voteOnDispute">voteOnDispute</a></li><li><a href="global.html#webhookLogger">webhookLogger</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Tue Jun 24 2025 14:11:53 GMT-0300 (Brasilia Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
